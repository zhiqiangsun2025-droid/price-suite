# ✅ 前后端分工清单（超级具体版）

## 一、后端（服务器）负责的工作

### ✅ 1. 爬虫（无头浏览器）

```python
# 后端代码（server/app.py）

from selenium import webdriver
from selenium.webdriver.chrome.options import Options

def scrape_source_platform(category, timerange, count, growth_threshold, allow_official):
    """
    爬取抖音商品
    ✅ 在服务器运行
    ✅ 使用无头浏览器（客户端看不见）
    """
    options = Options()
    options.add_argument('--headless')  # ✅ 无头模式
    options.add_argument('--no-sandbox')
    driver = webdriver.Chrome(options=options)
    
    # 1. 打开抖音
    driver.get("https://haohuo.jinritemai.com")
    
    # 2. 搜索类目
    search_box = driver.find_element('css selector', 'input.search')
    search_box.send_keys(category)
    search_box.submit()
    
    # 3. 应用时间筛选（近7天等）
    # ...
    
    # 4. 抓取商品
    products = []
    items = driver.find_elements('css selector', '.product-item')
    
    for item in items[:count]:
        title = item.find_element('.title').text
        price = float(item.find_element('.price').text.replace('¥', ''))
        url = item.find_element('a').get_attribute('href')
        sales = int(item.find_element('.sales').text)
        
        # ✅ 计算销量增长（服务器计算）
        sales_7days_ago = get_historical_sales(url, days=7)
        growth_rate = (sales - sales_7days_ago) / sales_7days_ago
        
        # 只保留增长≥阈值的
        if growth_rate >= growth_threshold:
            products.append({
                'title': title,
                'price': price,
                'url': url,
                'sales': sales,
                'growth_rate': f"{growth_rate:.1%}",  # ✅ 服务器计算好百分比
                'image_url': item.find_element('img').get_attribute('src')
            })
    
    driver.quit()
    return products
```

### ✅ 2. AI商品匹配

```python
# 后端代码（server/app.py 调用 ai_matcher.py）

from ai_matcher import ProductMatcher

def search_and_match_pinduoduo(douyin_product):
    """
    在拼多多搜索并匹配商品
    ✅ 全在服务器运行
    """
    # 2.1 爬取拼多多
    driver.get("https://mobile.yangkeduo.com/search")
    driver.find_element('input').send_keys(douyin_product['title'])
    driver.find_element('button').click()
    
    pdd_products = []
    for item in driver.find_elements('.goods-item')[:20]:
        pdd_products.append({
            'title': item.find_element('.title').text,
            'price': float(item.find_element('.price').text),
            'url': item.find_element('a').get_attribute('href'),
            'image_url': item.find_element('img').get_attribute('src')
        })
    
    # 2.2 AI匹配（✅ 服务器计算）
    matcher = ProductMatcher()
    matches = matcher.match_products(douyin_product, pdd_products)
    
    # matches = [(pdd_product, 相似度), ...]
    # 例如: [({...}, 0.87), ({...}, 0.65), ...]
    
    return matches
```

### ✅ 3. 价格对比计算

```python
# 后端代码（server/app.py）

def calculate_discount(douyin_price, pdd_price):
    """
    计算价差
    ✅ 服务器计算
    """
    discount = (douyin_price - pdd_price) / douyin_price
    return f"{discount:.1%}"  # 返回 "53.9%"
```

### ✅ 4. 返回JSON数据

```python
# 后端API（server/app.py）

@app.route('/api/intelligent-selection', methods=['POST'])
@require_auth
def intelligent_selection():
    """
    智能选品API
    ✅ 接收参数
    ✅ 执行所有爬虫+匹配+计算
    ✅ 返回结构化JSON
    """
    data = request.json
    
    # 1. 爬抖音
    douyin_products = scrape_source_platform(
        category=data['category'],
        timerange=data['timerange'],
        count=data['count'],
        growth_threshold=data['growth_threshold'],
        allow_official=data['allow_official']
    )
    
    # 2. 逐个匹配拼多多
    results = []
    for dy_prod in douyin_products:
        pdd_matches = search_and_match_pinduoduo(dy_prod)
        
        for pdd_prod, similarity in pdd_matches:
            if similarity < 0.6:
                continue
            
            # 3. 计算价差
            discount = calculate_discount(dy_prod['price'], pdd_prod['price'])
            
            if float(discount.strip('%')) / 100 >= data['discount_threshold']:
                results.append({
                    'title': dy_prod['title'],
                    'douyin_url': dy_prod['url'],
                    'douyin_price': dy_prod['price'],
                    'douyin_sales': dy_prod['sales'],
                    'growth_rate': dy_prod['growth_rate'],  # ✅ 已计算好
                    'pdd_urls': [pdd_prod['url']],
                    'pdd_price': pdd_prod['price'],
                    'discount_rate': discount,  # ✅ 已计算好 "53.9%"
                    'similarity': f"{similarity:.1%}",  # ✅ 已计算好 "87%"
                    'image_url': dy_prod['image_url']
                })
    
    # 4. 返回JSON
    return jsonify({
        'success': True,
        'data': results,
        'total': len(results)
    })
```

---

## 二、前端（客户端）负责的工作

### ✅ 1. 收集用户输入

```python
# 客户端代码（client/modern_client.py）

def start_intelligent_selection(self):
    """
    收集参数并发送到服务器
    ❌ 不做任何计算
    ❌ 不做任何爬虫
    """
    # 1. 获取用户输入
    category = self.category_entry.get()  # "女装/连衣裙"
    timerange = self.timerange_combo.get()  # "近7天"
    count = int(self.count_entry.get())  # 50
    discount = float(self.discount_entry.get()) / 100  # 0.30
    growth = float(self.growth_entry.get()) / 100  # 0.20
    
    # 2. 打包成JSON
    data = {
        'category': category,
        'timerange': timerange,
        'count': count,
        'discount_threshold': discount,
        'growth_threshold': growth,
        'allow_official': True
    }
    
    # 3. 发送到服务器
    response = requests.post(
        f"{self.server_url}/api/intelligent-selection",
        headers={
            'X-Client-ID': self.client_id,
            'X-Hardware-ID': self.hardware_id
        },
        json=data
    )
    
    result = response.json()
    # result = {
    #     'success': True,
    #     'data': [
    #         {
    #             'title': '...',
    #             'douyin_price': 128.00,
    #             'pdd_price': 59.00,
    #             'discount_rate': '53.9%',  # ✅ 服务器已经算好
    #             'growth_rate': '43%',  # ✅ 服务器已经算好
    #             ...
    #         },
    #         ...
    #     ]
    # }
```

### ✅ 2. 显示结果

```python
# 客户端代码（client/modern_client.py）

def display_results(self, products):
    """
    显示服务器返回的数据
    ❌ 不做任何计算，只是展示
    """
    self.result_text.delete("1.0", "end")
    
    # 表头
    header = f"{'序号':<4} {'商品标题':<30} {'抖音价':<8} {'拼多多':<8} {'价差':<8} {'销量增长':<10}\n"
    self.result_text.insert("end", header)
    
    # 逐行显示（数据都是服务器计算好的）
    for idx, p in enumerate(products, 1):
        row = (
            f"{idx:<4} "
            f"{p['title'][:28]:<30} "
            f"¥{p['douyin_price']:<7.2f} "
            f"¥{p['pdd_price']:<7.2f} "
            f"{p['discount_rate']:<8} "  # ✅ 服务器算好的 "53.9%"
            f"{p['growth_rate']:<10}\n"  # ✅ 服务器算好的 "43%"
        )
        self.result_text.insert("end", row)
```

### ✅ 3. 导出Excel

```python
# 客户端代码（client/modern_client.py）

def export_to_excel(self):
    """
    把服务器返回的JSON导出为Excel
    ✅ 在客户端本地生成Excel
    ❌ 服务器不参与Excel生成
    """
    import pandas as pd
    import os
    from datetime import datetime
    
    # 1. 把JSON转成DataFrame
    df = pd.DataFrame(self.current_result)
    # self.current_result 就是服务器返回的 data 数组
    
    # 2. 调整列
    df = df[[
        'title', 'douyin_url', 'douyin_price', 'douyin_sales', 'growth_rate',
        'pdd_urls', 'pdd_price', 'discount_rate', 'similarity'
    ]]
    
    # 3. 重命名列（中文）
    df.columns = [
        '商品标题', '抖音链接', '抖音价格', '抖音销量', '销量增长',
        '拼多多链接', '拼多多价格', '价差', '相似度'
    ]
    
    # 4. 保存到客户桌面
    desktop = os.path.join(os.path.expanduser("~"), "Desktop")
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"选品结果_{timestamp}.xlsx"
    filepath = os.path.join(desktop, filename)
    
    # 5. 导出
    df.to_excel(filepath, index=False, sheet_name='选品结果')
    
    self.last_excel_path = filepath  # 保存路径，供RPA使用
    print(f"✅ Excel保存在: {filepath}")
```

### ✅ 4. 调用RPA

```python
# 客户端代码（client/modern_client.py）

def start_listing(self):
    """
    启动RPA自动化
    ✅ 调用本地RPA脚本
    ❌ RPA不与服务器通信
    """
    import subprocess
    
    # RPA脚本路径
    rpa_script = os.path.join(os.path.dirname(__file__), '..', 'rpa', 'rpa_controller.py')
    
    # 调用RPA，传入Excel路径和列名
    subprocess.Popen([
        'python',
        rpa_script,
        '--excel', self.last_excel_path,  # C:\Users\xxx\Desktop\选品结果_20241007.xlsx
        '--column', '抖音链接'  # 读取"抖音链接"这一列
    ])
    
    print("✅ RPA已启动")
```

---

## 三、RPA（客户端本地）负责的工作

### ✅ 1. 读取Excel

```python
# RPA代码（rpa/rpa_controller.py）

def main():
    import pandas as pd
    
    # 1. 读取Excel（客户端刚生成的）
    df = pd.read_excel("C:\\Users\\客户\\Desktop\\选品结果_20241007.xlsx")
    
    # 2. 读取"抖音链接"列
    links = df['抖音链接'].tolist()
    
    # links = [
    #     "https://haohuo.jinritemai.com/item/123",
    #     "https://haohuo.jinritemai.com/item/456",
    #     ...
    # ]
    
    print(f"✅ 读取到 {len(links)} 个链接")
```

### ✅ 2. 自动操作铺货软件

```python
# RPA代码（rpa/rpa_controller.py）

import pyautogui
import pywinauto
import time

def run_full_process(links):
    """
    自动铺货流程
    ✅ 在客户电脑本地运行
    ❌ 不联网
    ❌ 不与服务器通信
    """
    # 1. 打开铺货软件
    os.startfile("C:\\铺货软件\\app.exe")
    time.sleep(5)
    
    # 2. 逐个输入链接
    for idx, link in enumerate(links, 1):
        print(f"[{idx}/{len(links)}] 正在铺货: {link}")
        
        # 2.1 找到输入框（图像识别）
        input_pos = pyautogui.locateOnScreen('templates/input_box.png')
        pyautogui.click(input_pos)
        
        # 2.2 粘贴链接
        import pyperclip
        pyperclip.copy(link)
        pyautogui.hotkey('ctrl', 'v')
        
        # 2.3 点击"铺货"按钮
        list_btn = pyautogui.locateOnScreen('templates/listing_btn.png')
        pyautogui.click(list_btn)
        
        # 2.4 等待铺货完成
        time.sleep(3)
    
    print("✅ 所有商品铺货完成")
```

---

## 四、数据流向（逐步详解）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 客户端收集参数                                       │
│ ───────────────────────────────────────────────────────────│
│  用户输入:                                                   │
│    category = "女装/连衣裙"                                  │
│    timerange = "近7天"                                       │
│    count = 50                                                │
│    discount_threshold = 0.30                                 │
│    growth_threshold = 0.20                                   │
│                                                              │
│  客户端代码:                                                 │
│    data = { 上述参数 }                                       │
│    requests.post(f"{server}/api/intelligent-selection", json=data)
└─────────────────────────────────────────────────────────────┘
                         ↓ HTTP POST (JSON)
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 服务器爬取抖音（无头浏览器）                         │
│ ───────────────────────────────────────────────────────────│
│  服务器代码:                                                 │
│    driver = webdriver.Chrome(options=headless)              │
│    driver.get("抖音")                                        │
│    搜索("女装/连衣裙")                                       │
│    应用筛选("近7天")                                         │
│    抓取前50个商品                                            │
│                                                              │
│  爬到的数据:                                                 │
│    douyin_products = [                                       │
│      {                                                       │
│        title: "连衣裙...",                                   │
│        price: 128.00,                                        │
│        url: "https://...",                                   │
│        sales: 5000,                                          │
│        sales_7days_ago: 3500,                                │
│      },                                                      │
│      ...                                                     │
│    ]                                                         │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 服务器计算销量增长                                   │
│ ───────────────────────────────────────────────────────────│
│  服务器代码:                                                 │
│    for p in douyin_products:                                │
│      growth = (p.sales - p.sales_7days_ago) / p.sales_7days_ago
│      p.growth_rate = f"{growth:.1%}"  # "43%"               │
│                                                              │
│      if growth < 0.20:  # 过滤掉增长<20%的                  │
│        remove(p)                                             │
│                                                              │
│  过滤后: 还剩28个商品                                        │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 服务器搜索拼多多（无头浏览器）                       │
│ ───────────────────────────────────────────────────────────│
│  For 每个抖音商品:                                          │
│    driver.get("拼多多")                                      │
│    搜索(商品标题)                                            │
│    抓取前20个结果                                            │
│                                                              │
│  得到:                                                       │
│    pdd_candidates = [                                        │
│      {title: "连衣裙...", price: 59, url: "..."},           │
│      {title: "连衣裙...", price: 78, url: "..."},           │
│      ...                                                     │
│    ]                                                         │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: 服务器AI匹配（判断是否同款）                         │
│ ───────────────────────────────────────────────────────────│
│  服务器代码:                                                 │
│    from ai_matcher import ProductMatcher                    │
│    matcher = ProductMatcher()                               │
│                                                              │
│    matches = matcher.match_products(                        │
│      douyin_product,                                        │
│      pdd_candidates                                         │
│    )                                                         │
│                                                              │
│  结果:                                                       │
│    matches = [                                               │
│      (pdd_prod1, 0.87),  # 87%相似                          │
│      (pdd_prod2, 0.65),  # 65%相似                          │
│      (pdd_prod3, 0.42),  # 42%相似（舍弃）                  │
│    ]                                                         │
│                                                              │
│  只保留相似度≥60%的                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: 服务器计算价差                                       │
│ ───────────────────────────────────────────────────────────│
│  For 每个匹配:                                              │
│    discount = (128 - 59) / 128 = 0.539                      │
│    discount_rate = "53.9%"                                  │
│                                                              │
│    if discount >= 0.30:  # 满足30%阈值                      │
│      加入结果                                                │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 7: 服务器返回JSON                                       │
│ ───────────────────────────────────────────────────────────│
│  return jsonify({                                            │
│    'success': True,                                          │
│    'data': [                                                 │
│      {                                                       │
│        'title': '连衣裙...',                                 │
│        'douyin_url': 'https://...',                         │
│        'douyin_price': 128.00,                              │
│        'douyin_sales': 5000,                                │
│        'growth_rate': '43%',  # ✅ 服务器算好的              │
│        'pdd_urls': ['https://...'],                         │
│        'pdd_price': 59.00,                                  │
│        'discount_rate': '53.9%',  # ✅ 服务器算好的          │
│        'similarity': '87%',  # ✅ 服务器算好的               │
│      },                                                      │
│      ...  (共15个符合条件的商品)                            │
│    ]                                                         │
│  })                                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓ HTTP Response (JSON)
┌─────────────────────────────────────────────────────────────┐
│ Step 8: 客户端显示结果                                       │
│ ───────────────────────────────────────────────────────────│
│  客户端代码:                                                 │
│    result = response.json()                                 │
│    for p in result['data']:                                 │
│      显示(                                                   │
│        p['title'],                                           │
│        p['douyin_price'],  # 128.00                         │
│        p['pdd_price'],  # 59.00                             │
│        p['discount_rate'],  # "53.9%" ← 服务器算好的        │
│        p['growth_rate']  # "43%" ← 服务器算好的             │
│      )                                                       │
│                                                              │
│  ❌ 客户端不做任何计算，只是显示                             │
└─────────────────────────────────────────────────────────────┘
                         ↓ 用户点击"导出Excel"
┌─────────────────────────────────────────────────────────────┐
│ Step 9: 客户端导出Excel                                      │
│ ───────────────────────────────────────────────────────────│
│  客户端代码:                                                 │
│    df = pd.DataFrame(result['data'])                        │
│    df.to_excel("C:\\Users\\客户\\Desktop\\选品结果.xlsx")   │
│                                                              │
│  Excel内容:                                                  │
│  ┌──────┬────────┬──────┬────────┬──────┬───────┐        │
│  │ 标题 │抖音链接│抖音价│拼多多价│ 价差 │销量增长│        │
│  ├──────┼────────┼──────┼────────┼──────┼───────┤        │
│  │连衣裙│https://│ 128  │  59    │53.9% │ 43%   │        │
│  │...   │...     │  ... │  ...   │ ...  │ ...   │        │
│  └──────┴────────┴──────┴────────┴──────┴───────┘        │
│                                                              │
│  ✅ Excel保存在客户本地                                      │
│  ❌ 服务器不参与Excel生成                                    │
└─────────────────────────────────────────────────────────────┘
                         ↓ 用户点击"一键铺货"
┌─────────────────────────────────────────────────────────────┐
│ Step 10: 客户端调用RPA                                       │
│ ───────────────────────────────────────────────────────────│
│  客户端代码:                                                 │
│    subprocess.Popen([                                        │
│      'python',                                               │
│      'rpa/rpa_controller.py',                               │
│      '--excel', 'C:\\Users\\...\\选品结果.xlsx',            │
│      '--column', '抖音链接'                                  │
│    ])                                                        │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 11: RPA读取Excel并自动操作                              │
│ ───────────────────────────────────────────────────────────│
│  RPA代码:                                                    │
│    df = pd.read_excel("选品结果.xlsx")                      │
│    links = df['抖音链接'].tolist()                           │
│                                                              │
│    # 打开铺货软件                                            │
│    os.startfile("铺货软件.exe")                             │
│                                                              │
│    # 逐个输入链接                                            │
│    for link in links:                                       │
│      pyautogui.click(input_box)                             │
│      pyperclip.copy(link)                                   │
│      pyautogui.hotkey('ctrl', 'v')                          │
│      pyautogui.click(listing_btn)                           │
│      time.sleep(3)                                          │
│                                                              │
│  ❌ RPA不联网                                                │
│  ❌ RPA不与服务器通信                                        │
│  ✅ RPA只读Excel，操作本地软件                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、总结表格

| 功能 | 在哪里执行 | 代码位置 | 是否联网 |
|------|-----------|---------|---------|
| **收集参数** | 客户端 | `client/modern_client.py` | ✅ 发送给服务器 |
| **爬取抖音** | 服务器 | `server/app.py` | ✅ |
| **计算销量增长** | 服务器 | `server/app.py` | ❌ |
| **爬取拼多多** | 服务器 | `server/app.py` | ✅ |
| **AI匹配** | 服务器 | `server/ai_matcher.py` | ❌ |
| **计算价差** | 服务器 | `server/app.py` | ❌ |
| **返回JSON** | 服务器 | `server/app.py` | ✅ |
| **显示结果** | 客户端 | `client/modern_client.py` | ❌ |
| **生成Excel** | 客户端 | `client/modern_client.py` | ❌ |
| **调用RPA** | 客户端 | `client/modern_client.py` | ❌ |
| **读取Excel** | RPA | `rpa/rpa_controller.py` | ❌ |
| **自动铺货** | RPA | `rpa/rpa_controller.py` | ❌ |

---

## 六、关键点总结

### ✅ 服务器（后端）

- 所有爬虫（Selenium无头浏览器）
- 所有计算（销量增长、价差、相似度）
- 所有AI匹配
- 返回计算好的数据（JSON）

### ✅ 客户端（前端）

- 收集用户输入
- 发送参数到服务器
- 显示服务器返回的数据（不计算）
- 生成Excel（本地）
- 调用RPA

### ✅ RPA

- 读取Excel（客户端生成的）
- 自动操作铺货软件
- 完全本地运行（不联网）

---

这样分工的好处：
1. ✅ **客户端无法破解**（没有核心逻辑）
2. ✅ **服务器集中管理**（随时更新爬虫策略）
3. ✅ **Excel本地生成**（快速、无需下载）
4. ✅ **RPA离线运行**（不依赖网络）

