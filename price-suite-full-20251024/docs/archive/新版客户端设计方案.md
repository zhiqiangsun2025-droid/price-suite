# ğŸ¯ æ–°ç‰ˆå®¢æˆ·ç«¯è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ”¹è¿›ç›®æ ‡

1. **å»æ‰æ¿€æ´»é¡µé¢**ï¼šå¯åŠ¨ç›´æ¥è¿›å…¥ä¸»ç•Œé¢
2. **è‡ªåŠ¨æ³¨å†Œ**ï¼šé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨æ³¨å†Œåˆ°æœåŠ¡å™¨
3. **è¯•ç”¨æœŸæœºåˆ¶**ï¼šæœªæˆæƒå¯è¯•ç”¨1å°æ—¶
4. **å‹å¥½æç¤º**ï¼šè¯•ç”¨æœŸåˆ°æ˜¾ç¤ºå‹å¥½åŠ¨ç”»
5. **ä¸‰é‡éªŒè¯**ï¼šå®¢æˆ·ç«¯ID + ç¡¬ä»¶ID + IPåœ°å€

---

## ğŸ”„ æ–°çš„å¯åŠ¨æµç¨‹

```python
def __init__(self):
    super().__init__()
    
    # 1. è·å–ç¡¬ä»¶ID
    self.hardware_id = get_hardware_id()
    
    # 2. åŠ è½½æœ¬åœ°é…ç½®
    config = load_client_config()
    
    # 3. è‡ªåŠ¨æ³¨å†Œ/éªŒè¯
    auth_result = self.auto_register()
    
    if auth_result['success']:
        self.client_id = auth_result['client_id']
        self.is_active = auth_result['is_active']
        self.expires_at = auth_result['expires_at']
        
        # 4a. å·²æˆæƒï¼šç›´æ¥è¿›å…¥ä¸»ç•Œé¢
        if self.is_active == 1:
            self.create_main_ui()
        
        # 4b. å¾…å®¡æ ¸ï¼šè¿›å…¥è¯•ç”¨æ¨¡å¼
        elif self.is_active == 0:
            self.start_trial_mode()
        
        # 4c. å·²æ‹’ç»ï¼šæ˜¾ç¤ºæ‹’ç»æç¤º
        else:
            self.show_rejected_dialog()
    else:
        # ç½‘ç»œé”™è¯¯
        self.show_error_dialog(auth_result['error'])
```

---

## ğŸ• è¯•ç”¨æœŸå®ç°

### 1. é¦–æ¬¡å¯åŠ¨è®°å½•æ—¶é—´

```python
def start_trial_mode(self):
    """å¯åŠ¨è¯•ç”¨æ¨¡å¼"""
    # è¯»å–é¦–æ¬¡å¯åŠ¨æ—¶é—´
    trial_start = self.get_trial_start_time()
    if not trial_start:
        trial_start = datetime.now().timestamp()
        self.save_trial_start_time(trial_start)
    
    # è®¡ç®—å‰©ä½™æ—¶é—´
    elapsed = datetime.now().timestamp() - trial_start
    remaining = 3600 - elapsed  # 1å°æ—¶ = 3600ç§’
    
    if remaining > 0:
        # è¿˜åœ¨è¯•ç”¨æœŸå†…
        self.create_main_ui()
        self.show_trial_banner(remaining)
        self.start_trial_timer(remaining)
    else:
        # è¯•ç”¨æœŸå·²åˆ°
        self.show_trial_expired_dialog()
```

### 2. é¡¶éƒ¨è¯•ç”¨æç¤ºæ¡

```python
def show_trial_banner(self, remaining_seconds):
    """æ˜¾ç¤ºè¯•ç”¨æœŸæç¤ºæ¡"""
    banner = ctk.CTkFrame(self, fg_color="#FFA500", height=40)
    banner.pack(fill="x", side="top")
    
    minutes = int(remaining_seconds / 60)
    label = ctk.CTkLabel(
        banner,
        text=f"â° è¯•ç”¨ç‰ˆï¼šå‰©ä½™ {minutes} åˆ†é’Ÿ | è¯·è”ç³»ç®¡ç†å‘˜è·å–æˆæƒ",
        font=ctk.CTkFont(size=14, weight="bold"),
        text_color="white"
    )
    label.pack(pady=10)
```

### 3. å€’è®¡æ—¶å®šæ—¶å™¨

```python
def start_trial_timer(self, remaining_seconds):
    """å¯åŠ¨å€’è®¡æ—¶"""
    def check_trial():
        trial_start = self.get_trial_start_time()
        elapsed = datetime.now().timestamp() - trial_start
        remaining = 3600 - elapsed
        
        if remaining <= 0:
            # è¯•ç”¨æœŸåˆ°äº†
            self.show_trial_expired_dialog()
        else:
            # æ›´æ–°æç¤ºæ¡
            minutes = int(remaining / 60)
            # æ›´æ–°UI...
            
            # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            self.after(60000, check_trial)
    
    check_trial()
```

### 4. åˆ°æœŸå‹å¥½æç¤º

```python
def show_trial_expired_dialog(self):
    """æ˜¾ç¤ºè¯•ç”¨æœŸåˆ°æœŸå¯¹è¯æ¡†"""
    # æ¸…ç©ºä¸»ç•Œé¢
    for widget in self.winfo_children():
        widget.destroy()
    
    # ä¸­å¿ƒå®¹å™¨
    center = ctk.CTkFrame(self, fg_color="transparent")
    center.pack(expand=True)
    
    # å‹å¥½åŠ¨ç”»ï¼ˆå¯ç”¨emojiæˆ–å›¾ç‰‡ï¼‰
    icon = ctk.CTkLabel(
        center,
        text="â°",
        font=ctk.CTkFont(size=80)
    )
    icon.pack(pady=30)
    
    # æ ‡é¢˜
    title = ctk.CTkLabel(
        center,
        text="è¯•ç”¨æœŸå·²ç»“æŸ",
        font=ctk.CTkFont(size=32, weight="bold")
    )
    title.pack(pady=20)
    
    # è¯´æ˜
    msg = ctk.CTkLabel(
        center,
        text="æ„Ÿè°¢æ‚¨çš„è¯•ç”¨ï¼\\nå¦‚éœ€ç»§ç»­ä½¿ç”¨ï¼Œè¯·è”ç³»å¼€å‘è€…è·å–æˆæƒ",
        font=ctk.CTkFont(size=16),
        text_color="gray"
    )
    msg.pack(pady=10)
    
    # è”ç³»æ–¹å¼
    contact_frame = ctk.CTkFrame(center, corner_radius=10)
    contact_frame.pack(pady=30, padx=40)
    
    ctk.CTkLabel(
        contact_frame,
        text="ğŸ“® è”ç³»æ–¹å¼",
        font=ctk.CTkFont(size=18, weight="bold")
    ).pack(pady=(20,10))
    
    ctk.CTkLabel(
        contact_frame,
        text="QQ: 123456789\\nå¾®ä¿¡: your_wechat\\né‚®ç®±: your@email.com",
        font=ctk.CTkFont(size=14)
    ).pack(pady=(0,20))
    
    # æŒ‰é’®
    btn_frame = ctk.CTkFrame(center, fg_color="transparent")
    btn_frame.pack(pady=20)
    
    ctk.CTkButton(
        btn_frame,
        text="å¤åˆ¶QQå·",
        command=lambda: self.copy_to_clipboard("123456789"),
        width=150
    ).pack(side="left", padx=10)
    
    ctk.CTkButton(
        btn_frame,
        text="é€€å‡ºç¨‹åº",
        command=self.quit,
        fg_color="gray",
        width=150
    ).pack(side="left", padx=10)
```

---

## ğŸ” ä¸‰é‡éªŒè¯å®ç°

### 1. å®¢æˆ·ç«¯è°ƒç”¨APIæ—¶

```python
def call_api(self, endpoint, data=None):
    """è°ƒç”¨æœåŠ¡å™¨APIï¼ˆæ¯æ¬¡éƒ½éªŒè¯ï¼‰"""
    headers = {
        'X-Client-ID': self.client_id,
        'X-Hardware-ID': self.hardware_id,
        'Content-Type': 'application/json'
    }
    
    try:
        response = requests.post(
            f"{self.server_url}{endpoint}",
            json=data,
            headers=headers,
            timeout=10
        )
        result = response.json()
        
        # æ£€æŸ¥æˆæƒçŠ¶æ€
        if not result.get('success'):
            error = result.get('error', '')
            if 'æœªæˆæƒ' in error or 'å·²æ‹’ç»' in error:
                self.show_trial_expired_dialog()
                return None
        
        return result
    except Exception as e:
        messagebox.showerror("ç½‘ç»œé”™è¯¯", str(e))
        return None
```

### 2. æœåŠ¡å™¨ç«¯éªŒè¯ï¼ˆå·²å®ç°ï¼‰

```python
@app.before_request
def require_auth():
    """æ¯ä¸ªAPIè¯·æ±‚å‰éªŒè¯"""
    if request.path.startswith('/api/') and request.path != '/api/register':
        client_id = request.headers.get('X-Client-ID')
        hardware_id = request.headers.get('X-Hardware-ID')
        ip_address = request.remote_addr
        
        # æŸ¥è¯¢æ•°æ®åº“
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        c.execute('''
            SELECT * FROM authorizations 
            WHERE client_id=? AND hardware_id=?
        ''', (client_id, hardware_id))
        auth = c.fetchone()
        conn.close()
        
        # éªŒè¯
        if not auth:
            return jsonify({'success': False, 'error': 'æœªæˆæƒ'}), 403
        
        if auth[5] == 0:
            return jsonify({'success': False, 'error': 'ç­‰å¾…å®¡æ ¸'}), 403
        
        if auth[5] == -1:
            return jsonify({'success': False, 'error': 'å·²æ‹’ç»'}), 403
        
        if auth[7] and datetime.strptime(auth[7], '%Y-%m-%d %H:%M:%S') < datetime.now():
            return jsonify({'success': False, 'error': 'æˆæƒå·²è¿‡æœŸ'}), 403
```

---

## ğŸ“¦ é…ç½®æ–‡ä»¶æ ¼å¼

### client_config.json

```json
{
  "client_id": "a3f5e8d7c2b1...",
  "server_url": "http://172.19.251.155:5000",
  "hardware_id": "45d4ff286348...",
  "trial_start_time": 1696843200,
  "is_active": 0,
  "expires_at": null
}
```

---

## ğŸ¨ UIæ”¹è¿›

### 1. å»æ‰æ¿€æ´»é¡µé¢
- âœ… å¯åŠ¨ç›´æ¥æ˜¾ç¤ºä¸»ç•Œé¢
- âœ… é¡¶éƒ¨æ˜¾ç¤ºè¯•ç”¨çŠ¶æ€æ¡

### 2. çŠ¶æ€æŒ‡ç¤º

```
å·²æˆæƒï¼šç»¿è‰²é¡¶æ  "âœ“ å·²æˆæƒ | åˆ°æœŸæ—¶é—´ï¼š2026-10-09"
è¯•ç”¨ä¸­ï¼šæ©™è‰²é¡¶æ  "â° è¯•ç”¨ç‰ˆï¼šå‰©ä½™ 45 åˆ†é’Ÿ | è¯·è”ç³»ç®¡ç†å‘˜"
æœªæˆæƒï¼šé”å®šç•Œé¢ï¼Œæ˜¾ç¤ºè”ç³»æ–¹å¼
```

---

## ğŸ“± å®Œæ•´ä»£ç ç¤ºä¾‹

è§é™„ä»¶ï¼š`modern_client_v2.py`

---

## âœ… æ”¹è¿›æ¸…å•

- [x] åå°ç•Œé¢ç¾åŒ–ï¼ˆè‡ªé€‚åº”+å¤åˆ¶æŒ‰é’®ï¼‰
- [x] åå°æ·»åŠ æ‰¹å‡†/æ‹’ç»æŒ‰é’®
- [x] åç«¯è‡ªåŠ¨æ³¨å†ŒAPI
- [ ] å®¢æˆ·ç«¯å»æ‰æ¿€æ´»é¡µé¢
- [ ] å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œ
- [ ] å®¢æˆ·ç«¯è¯•ç”¨æœŸæœºåˆ¶ï¼ˆ1å°æ—¶ï¼‰
- [ ] å®¢æˆ·ç«¯å‹å¥½åˆ°æœŸæç¤º

---

**ä¸‹ä¸€æ­¥ï¼šå®ç°æ–°ç‰ˆå®¢æˆ·ç«¯ä»£ç **

