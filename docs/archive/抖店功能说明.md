# 抖店商品榜单爬取功能说明

## 📝 功能概述

本功能实现了自动登录抖店（抖音电商罗盘），爬取商品榜单数据，支持：
- 邮箱登录（带验证码交互）
- 多种榜单类型选择
- 时间范围筛选
- 行业类目筛选
- 品牌类型筛选

---

## 🏗️ 架构设计

### 后端（无头浏览器）
- **爬虫模块**：`douyin_scraper_v2.py`
- **API接口**：`app.py` 中新增的4个端点
- **技术栈**：Selenium + Chrome Headless

### 前端（客户端）
- **UI界面**：`modern_client.py` 中的智能选品页面
- **验证码输入**：弹窗对话框，客户手动输入
- **进度显示**：实时更新状态提示

---

## 🔄 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端操作流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣  选择榜单参数                                           │
│     ├─ 榜单类型：搜索榜/直播榜/商品卡榜/达人带货榜等        │
│     ├─ 时间段：近1天/近7天/近30天                          │
│     ├─ 品类类型：知名品牌/新锐品牌/价格带/自营             │
│     └─ 筛选数量：1-100                                     │
│                                                             │
│  2️⃣  点击"开始智能选品"                                     │
│                                                             │
│  3️⃣  后端开始登录抖店                                       │
│     ├─ 填入邮箱：doudianpuhuo3@163.com                     │
│     ├─ 填入密码：Ping99re.com                              │
│     └─ 点击登录                                            │
│                                                             │
│  4️⃣  如果需要验证码：                                       │
│     ├─ 前端弹窗："请输入邮箱验证码"                        │
│     ├─ 客户去邮箱查看验证码                                │
│     ├─ 客户输入验证码，点击确定                            │
│     └─ 后端提交验证码，完成登录                            │
│                                                             │
│  5️⃣  登录成功后，自动跳转到商品榜单页面                     │
│                                                             │
│  6️⃣  根据客户选择的参数，点击对应选项                       │
│     ├─ 点击榜单类型（如"搜索榜"）                          │
│     ├─ 点击时间范围（如"近1天"）                           │
│     └─ 点击品类类型（如"知名品牌"）                        │
│                                                             │
│  7️⃣  滚动页面，加载更多商品                                 │
│                                                             │
│  8️⃣  提取商品数据                                           │
│     ├─ 商品标题                                            │
│     ├─ 商品价格                                            │
│     ├─ 销量/GMV                                            │
│     ├─ 商品链接                                            │
│     └─ 商品图片                                            │
│                                                             │
│  9️⃣  返回数据给前端                                         │
│                                                             │
│  🔟  前端显示结果 + 导出Excel                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📡 API接口说明

### 1️⃣ 开始登录
**接口**: `POST /api/douyin-login-start`

**请求体**:
```json
{
  "email": "doudianpuhuo3@163.com",
  "password": "Ping99re.com"
}
```

**响应**:
```json
{
  "success": true,
  "status": "need_code",  // 或 "success" / "error"
  "message": "需要输入邮箱验证码"
}
```

---

### 2️⃣ 提交验证码
**接口**: `POST /api/douyin-submit-code`

**请求体**:
```json
{
  "code": "123456"
}
```

**响应**:
```json
{
  "success": true,
  "message": "登录成功"
}
```

---

### 3️⃣ 获取可选选项（可选）
**接口**: `POST /api/douyin-get-options`

**响应**:
```json
{
  "success": true,
  "options": {
    "rank_types": ["搜索榜", "直播榜", "商品卡榜", ...],
    "time_ranges": ["近1天", "近7天", "近30天"],
    "categories": ["女装", "美妆", "食品", ...],
    "brand_types": ["知名品牌", "新锐品牌", ...],
    "price_ranges": ["0-50", "50-100", ...]
  }
}
```

---

### 4️⃣ 爬取商品
**接口**: `POST /api/douyin-scrape`

**请求体**:
```json
{
  "rank_type": "搜索榜",
  "time_range": "近1天",
  "category": "女装",
  "brand_type": "知名品牌",
  "limit": 50
}
```

**响应**:
```json
{
  "success": true,
  "products": [
    {
      "title": "商品名称",
      "price": "99.00",
      "sales": "1000+",
      "url": "https://...",
      "image": "https://..."
    }
  ],
  "count": 50
}
```

---

## 🔐 反爬虫策略

### 1. 模拟真实浏览器
- 使用真实的User-Agent
- 隐藏WebDriver特征
- 随机延迟（0.5-2秒）

### 2. 低频访问
- 一天只登录1-2次
- 保持session/cookies
- 避免短时间大量请求

### 3. 登录保持
- 登录成功后保存cookies
- 下次访问直接使用cookies
- 减少登录频率

---

## ⚠️ 注意事项

1. **验证码时机**：
   - 首次登录
   - 异常IP登录
   - 长时间未登录
   - 频繁操作

2. **Session管理**：
   - 后端维护一个爬虫实例池（`scraper_pool`）
   - 每个客户端一个独立的爬虫实例
   - 客户端关闭时调用 `/api/douyin-cleanup` 清理实例

3. **元素定位**：
   - 需要根据抖店实际页面结构调整XPath/CSS选择器
   - 抖店页面可能会改版，需定期维护

4. **行业类目选项**：
   - 当前需要实际访问页面才能获取完整列表
   - 建议使用 `/api/douyin-get-options` 动态获取

---

## 🛠️ 开发调试

### 测试爬虫模块

```bash
cd /home/user/projects/shopxo-master/apps/price-suite/server

# 本地测试（非headless，可看到浏览器操作）
python3 douyin_scraper_v2.py
```

### 查看日志

后端会打印详细日志：
- 登录步骤
- 元素定位
- 数据提取
- 错误信息

---

## 📦 下一步完善

- [ ] 实际访问抖店页面，完善元素定位
- [ ] 获取真实的行业类目列表
- [ ] 添加Session复用（减少登录次数）
- [ ] 添加代理IP支持（防止封号）
- [ ] 完善数据提取逻辑
- [ ] 添加Excel导出功能
- [ ] 集成拼多多对比功能

---

## 📞 联系方式

如有问题，请联系：
- **QQ**: 123456789

© 2025 智能选品系统

