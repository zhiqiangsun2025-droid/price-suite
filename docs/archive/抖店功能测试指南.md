# 抖店功能测试指南

## 🎯 测试目标

验证抖店登录、验证码交互、榜单爬取功能是否正常工作。

---

## 🔧 环境准备

### 服务器端（WSL/Linux）

1. **安装依赖**
```bash
cd /home/user/projects/shopxo-master/apps/price-suite/server
pip3 install selenium
```

2. **安装Chrome浏览器**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y wget gnupg
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
sudo apt-get update
sudo apt-get install -y google-chrome-stable
```

3. **安装ChromeDriver**
```bash
# 检查Chrome版本
google-chrome --version

# 下载对应版本的ChromeDriver
# 例如：Chrome 91.x.x.x
wget https://chromedriver.storage.googleapis.com/91.0.4472.101/chromedriver_linux64.zip
unzip chromedriver_linux64.zip
sudo mv chromedriver /usr/local/bin/
sudo chmod +x /usr/local/bin/chromedriver

# 验证
chromedriver --version
```

4. **启动服务器**
```bash
cd /home/user/projects/shopxo-master/apps/price-suite/server
python3 app.py
```

---

## 🧪 测试步骤

### 步骤1：测试爬虫模块（独立测试）

```bash
cd /home/user/projects/shopxo-master/apps/price-suite/server

# 创建测试脚本
cat > test_douyin.py << 'EOF'
from douyin_scraper_v2 import DouyinScraperV2

# 非headless模式，可以看到浏览器操作
scraper = DouyinScraperV2(headless=False)

try:
    # 初始化浏览器
    scraper.init_driver()
    print("✓ 浏览器初始化成功")
    
    # 开始登录
    print("\n开始登录抖店...")
    status, message = scraper.start_login(
        'doudianpuhuo3@163.com',
        'Ping99re.com'
    )
    
    print(f"状态：{status}")
    print(f"消息：{message}")
    
    # 如果需要验证码
    if status == 'need_code':
        print("\n请去邮箱查看验证码！")
        code = input("请输入验证码：")
        
        success, msg = scraper.submit_verification_code(code)
        print(f"验证码提交结果：{msg}")
        
        if not success:
            exit()
    
    # 进入榜单页
    print("\n进入商品榜单页面...")
    scraper.goto_product_rank()
    
    # 暂停，检查页面
    input("\n按回车继续获取选项...")
    
    # 获取所有选项
    print("\n获取页面选项...")
    options = scraper.get_all_rank_options()
    
    print("\n可用选项：")
    print(f"榜单类型：{options['rank_types']}")
    print(f"时间范围：{options['time_ranges']}")
    print(f"行业类目：{options['categories']}")
    print(f"品牌类型：{options['brand_types']}")
    
    # 暂停
    input("\n按回车继续选择选项...")
    
    # 选择选项
    print("\n选择选项：搜索榜 + 近1天...")
    scraper.select_options(
        rank_type='搜索榜',
        time_range='近1天'
    )
    
    # 暂停
    input("\n按回车继续爬取商品...")
    
    # 获取商品
    print("\n爬取商品...")
    products = scraper.get_products(limit=10)
    
    print(f"\n成功获取 {len(products)} 个商品：")
    for i, p in enumerate(products, 1):
        print(f"{i}. {p['title']}")
        print(f"   价格：{p['price']}")
        print(f"   链接：{p['url']}")
        print()
    
    print("\n✓ 测试完成！")
    
except Exception as e:
    print(f"\n❌ 错误：{str(e)}")
    import traceback
    traceback.print_exc()

finally:
    input("\n按回车关闭浏览器...")
    scraper.close()
EOF

# 运行测试
python3 test_douyin.py
```

**预期结果**：
- ✅ 浏览器打开抖店登录页
- ✅ 自动填入邮箱、密码
- ✅ 自动点击登录
- ✅ （如需）提示输入验证码
- ✅ 登录成功，跳转到榜单页
- ✅ 成功提取榜单选项
- ✅ 成功爬取商品数据

**可能的问题**：
1. **元素定位失败**：抖店页面结构可能与预期不同，需要调整XPath
2. **验证码必现**：首次登录一定需要验证码
3. **Session过期**：需要实现Cookie保存

---

### 步骤2：测试完整API流程（前后端集成）

1. **确保后端服务运行中**
```bash
# 如果没启动，在新终端运行：
cd /home/user/projects/shopxo-master/apps/price-suite/server
python3 app.py
```

2. **打开前端客户端**
- 从GitHub Actions下载最新的`.exe`文件
- 双击打开
- 点击"智能选品"
- 选择参数后点击"开始智能选品"

3. **观察流程**
- 前端显示"正在连接抖店..."
- 后端开始登录
- （如需）前端弹出验证码输入框
- 去邮箱查看验证码，输入并点击确定
- 前端显示"登录成功！"
- 前端显示"正在抓取商品..."
- 最终弹窗显示商品列表

**预期结果**：
- ✅ 整个流程顺畅，无报错
- ✅ 验证码弹窗样式美观，输入流畅
- ✅ 进度提示清晰
- ✅ 最终成功返回商品数据

---

## 🐛 常见问题排查

### 问题1：ChromeDriver版本不匹配

**错误信息**：
```
session not created: This version of ChromeDriver only supports Chrome version XX
```

**解决**：
```bash
# 查看Chrome版本
google-chrome --version  # 例如：91.0.4472.124

# 下载匹配版本的ChromeDriver
# 访问：https://chromedriver.chromium.org/downloads
# 或使用：https://googlechromelabs.github.io/chrome-for-testing/
```

---

### 问题2：元素定位失败

**错误信息**：
```
NoSuchElementException: Unable to locate element
```

**调试步骤**：
1. 设置 `headless=False`，观察浏览器实际显示
2. 打开浏览器开发者工具（F12）
3. 使用 `Ctrl+Shift+C` 选择元素
4. 复制正确的XPath/CSS选择器
5. 更新 `douyin_scraper_v2.py` 中的选择器

---

### 问题3：反爬虫检测

**症状**：
- 页面显示"检测到异常行为"
- 验证码频繁出现
- 登录后立即退出

**解决**：
1. **随机延迟**：在操作之间添加随机延迟
```python
import random
time.sleep(random.uniform(1, 3))
```

2. **保存Cookies**：登录成功后保存cookies
```python
# 保存
import pickle
cookies = self.driver.get_cookies()
with open('douyin_cookies.pkl', 'wb') as f:
    pickle.dump(cookies, f)

# 加载
with open('douyin_cookies.pkl', 'rb') as f:
    cookies = pickle.load(f)
for cookie in cookies:
    self.driver.add_cookie(cookie)
```

3. **使用代理IP**：
```python
from selenium.webdriver.chrome.options import Options
options = Options()
options.add_argument('--proxy-server=http://your-proxy:port')
```

4. **降低访问频率**：
- 一天只登录1-2次
- 爬取间隔 > 5秒
- 避免在深夜爬取

---

### 问题4：验证码识别

**当前方案**：客户手动输入（最简单、最稳定）

**高级方案**（可选）：
1. **打码平台**：超级鹰、若快、云打码
2. **OCR识别**：Tesseract、PaddleOCR
3. **AI识别**：YOLO、CNN

**不建议**：验证码破解违反服务条款，且成本高。

---

## 📊 性能优化建议

### 1. Session复用
```python
# 首次登录后保存session
session_id = self.driver.session_id
executor_url = self.driver.command_executor._url

# 下次直接恢复
from selenium.webdriver.remote.webdriver import WebDriver
self.driver = WebDriver(command_executor=executor_url, desired_capabilities={})
self.driver.session_id = session_id
```

### 2. 并发爬取
- 多个客户端共享一个session
- 后端维护session池
- 定时刷新session

### 3. 缓存榜单选项
- 选项不常变，可缓存24小时
- 减少页面加载次数

---

## 🎓 下一步优化

- [ ] **完善元素定位**：实际访问抖店，验证所有XPath
- [ ] **获取真实选项**：爬取行业类目的完整列表
- [ ] **Cookie持久化**：减少登录频率
- [ ] **错误重试机制**：网络波动时自动重试
- [ ] **日志记录**：详细的操作日志，便于调试
- [ ] **多账号轮换**：避免单账号频繁操作

---

## 📞 技术支持

测试过程中遇到问题，请提供：
1. 错误截图
2. 后端日志
3. Chrome版本
4. ChromeDriver版本
5. 操作系统版本

联系方式：
- **QQ**: 123456789

---

© 2025 智能选品系统

