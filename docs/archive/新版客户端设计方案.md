# 🎯 新版客户端设计方案

## 📋 改进目标

1. **去掉激活页面**：启动直接进入主界面
2. **自动注册**：首次启动自动注册到服务器
3. **试用期机制**：未授权可试用1小时
4. **友好提示**：试用期到显示友好动画
5. **三重验证**：客户端ID + 硬件ID + IP地址

---

## 🔄 新的启动流程

```python
def __init__(self):
    super().__init__()
    
    # 1. 获取硬件ID
    self.hardware_id = get_hardware_id()
    
    # 2. 加载本地配置
    config = load_client_config()
    
    # 3. 自动注册/验证
    auth_result = self.auto_register()
    
    if auth_result['success']:
        self.client_id = auth_result['client_id']
        self.is_active = auth_result['is_active']
        self.expires_at = auth_result['expires_at']
        
        # 4a. 已授权：直接进入主界面
        if self.is_active == 1:
            self.create_main_ui()
        
        # 4b. 待审核：进入试用模式
        elif self.is_active == 0:
            self.start_trial_mode()
        
        # 4c. 已拒绝：显示拒绝提示
        else:
            self.show_rejected_dialog()
    else:
        # 网络错误
        self.show_error_dialog(auth_result['error'])
```

---

## 🕐 试用期实现

### 1. 首次启动记录时间

```python
def start_trial_mode(self):
    """启动试用模式"""
    # 读取首次启动时间
    trial_start = self.get_trial_start_time()
    if not trial_start:
        trial_start = datetime.now().timestamp()
        self.save_trial_start_time(trial_start)
    
    # 计算剩余时间
    elapsed = datetime.now().timestamp() - trial_start
    remaining = 3600 - elapsed  # 1小时 = 3600秒
    
    if remaining > 0:
        # 还在试用期内
        self.create_main_ui()
        self.show_trial_banner(remaining)
        self.start_trial_timer(remaining)
    else:
        # 试用期已到
        self.show_trial_expired_dialog()
```

### 2. 顶部试用提示条

```python
def show_trial_banner(self, remaining_seconds):
    """显示试用期提示条"""
    banner = ctk.CTkFrame(self, fg_color="#FFA500", height=40)
    banner.pack(fill="x", side="top")
    
    minutes = int(remaining_seconds / 60)
    label = ctk.CTkLabel(
        banner,
        text=f"⏰ 试用版：剩余 {minutes} 分钟 | 请联系管理员获取授权",
        font=ctk.CTkFont(size=14, weight="bold"),
        text_color="white"
    )
    label.pack(pady=10)
```

### 3. 倒计时定时器

```python
def start_trial_timer(self, remaining_seconds):
    """启动倒计时"""
    def check_trial():
        trial_start = self.get_trial_start_time()
        elapsed = datetime.now().timestamp() - trial_start
        remaining = 3600 - elapsed
        
        if remaining <= 0:
            # 试用期到了
            self.show_trial_expired_dialog()
        else:
            # 更新提示条
            minutes = int(remaining / 60)
            # 更新UI...
            
            # 每分钟检查一次
            self.after(60000, check_trial)
    
    check_trial()
```

### 4. 到期友好提示

```python
def show_trial_expired_dialog(self):
    """显示试用期到期对话框"""
    # 清空主界面
    for widget in self.winfo_children():
        widget.destroy()
    
    # 中心容器
    center = ctk.CTkFrame(self, fg_color="transparent")
    center.pack(expand=True)
    
    # 友好动画（可用emoji或图片）
    icon = ctk.CTkLabel(
        center,
        text="⏰",
        font=ctk.CTkFont(size=80)
    )
    icon.pack(pady=30)
    
    # 标题
    title = ctk.CTkLabel(
        center,
        text="试用期已结束",
        font=ctk.CTkFont(size=32, weight="bold")
    )
    title.pack(pady=20)
    
    # 说明
    msg = ctk.CTkLabel(
        center,
        text="感谢您的试用！\\n如需继续使用，请联系开发者获取授权",
        font=ctk.CTkFont(size=16),
        text_color="gray"
    )
    msg.pack(pady=10)
    
    # 联系方式
    contact_frame = ctk.CTkFrame(center, corner_radius=10)
    contact_frame.pack(pady=30, padx=40)
    
    ctk.CTkLabel(
        contact_frame,
        text="📮 联系方式",
        font=ctk.CTkFont(size=18, weight="bold")
    ).pack(pady=(20,10))
    
    ctk.CTkLabel(
        contact_frame,
        text="QQ: 123456789\\n微信: your_wechat\\n邮箱: your@email.com",
        font=ctk.CTkFont(size=14)
    ).pack(pady=(0,20))
    
    # 按钮
    btn_frame = ctk.CTkFrame(center, fg_color="transparent")
    btn_frame.pack(pady=20)
    
    ctk.CTkButton(
        btn_frame,
        text="复制QQ号",
        command=lambda: self.copy_to_clipboard("123456789"),
        width=150
    ).pack(side="left", padx=10)
    
    ctk.CTkButton(
        btn_frame,
        text="退出程序",
        command=self.quit,
        fg_color="gray",
        width=150
    ).pack(side="left", padx=10)
```

---

## 🔐 三重验证实现

### 1. 客户端调用API时

```python
def call_api(self, endpoint, data=None):
    """调用服务器API（每次都验证）"""
    headers = {
        'X-Client-ID': self.client_id,
        'X-Hardware-ID': self.hardware_id,
        'Content-Type': 'application/json'
    }
    
    try:
        response = requests.post(
            f"{self.server_url}{endpoint}",
            json=data,
            headers=headers,
            timeout=10
        )
        result = response.json()
        
        # 检查授权状态
        if not result.get('success'):
            error = result.get('error', '')
            if '未授权' in error or '已拒绝' in error:
                self.show_trial_expired_dialog()
                return None
        
        return result
    except Exception as e:
        messagebox.showerror("网络错误", str(e))
        return None
```

### 2. 服务器端验证（已实现）

```python
@app.before_request
def require_auth():
    """每个API请求前验证"""
    if request.path.startswith('/api/') and request.path != '/api/register':
        client_id = request.headers.get('X-Client-ID')
        hardware_id = request.headers.get('X-Hardware-ID')
        ip_address = request.remote_addr
        
        # 查询数据库
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        c.execute('''
            SELECT * FROM authorizations 
            WHERE client_id=? AND hardware_id=?
        ''', (client_id, hardware_id))
        auth = c.fetchone()
        conn.close()
        
        # 验证
        if not auth:
            return jsonify({'success': False, 'error': '未授权'}), 403
        
        if auth[5] == 0:
            return jsonify({'success': False, 'error': '等待审核'}), 403
        
        if auth[5] == -1:
            return jsonify({'success': False, 'error': '已拒绝'}), 403
        
        if auth[7] and datetime.strptime(auth[7], '%Y-%m-%d %H:%M:%S') < datetime.now():
            return jsonify({'success': False, 'error': '授权已过期'}), 403
```

---

## 📦 配置文件格式

### client_config.json

```json
{
  "client_id": "a3f5e8d7c2b1...",
  "server_url": "http://172.19.251.155:5000",
  "hardware_id": "45d4ff286348...",
  "trial_start_time": 1696843200,
  "is_active": 0,
  "expires_at": null
}
```

---

## 🎨 UI改进

### 1. 去掉激活页面
- ✅ 启动直接显示主界面
- ✅ 顶部显示试用状态条

### 2. 状态指示

```
已授权：绿色顶栏 "✓ 已授权 | 到期时间：2026-10-09"
试用中：橙色顶栏 "⏰ 试用版：剩余 45 分钟 | 请联系管理员"
未授权：锁定界面，显示联系方式
```

---

## 📱 完整代码示例

见附件：`modern_client_v2.py`

---

## ✅ 改进清单

- [x] 后台界面美化（自适应+复制按钮）
- [x] 后台添加批准/拒绝按钮
- [x] 后端自动注册API
- [ ] 客户端去掉激活页面
- [ ] 客户端自动注册
- [ ] 客户端试用期机制（1小时）
- [ ] 客户端友好到期提示

---

**下一步：实现新版客户端代码**

