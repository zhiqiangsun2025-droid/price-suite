# 🔄 前后端数据流向详解（超级具体版）

## 一、前后端职责划分（一目了然）

### 🖥️ **客户端（前端）负责**

```python
✅ 收集用户输入
✅ 展示结果（表格/列表）
✅ 导出Excel（在客户本地生成）
✅ 调用RPA脚本
❌ 不做任何爬虫
❌ 不做价格对比
❌ 不做AI匹配
```

### 🔧 **服务器（后端）负责**

```python
✅ 所有爬虫逻辑（Selenium无头浏览器）
✅ AI商品匹配（文本+图片相似度）
✅ 价格对比计算
✅ 销量增长计算
✅ 返回结构化数据（JSON）
❌ 不生成Excel（客户端生成）
❌ 不控制RPA（客户端控制）
```

### 🤖 **RPA（客户端本地运行）**

```python
✅ 读取客户端导出的Excel
✅ 自动操作铺货软件
✅ 在客户本地电脑运行
❌ 不与服务器通信
```

---

## 二、完整数据流（每一步都清楚）

### 📊 **流程图**

```
┌────────────────────────────────────────────────────────────┐
│  第1步：客户端收集参数                                       │
├────────────────────────────────────────────────────────────┤
│  客户端 UI                                                  │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 用户输入:                                             │ │
│  │   类目: "女装/连衣裙"                                 │ │
│  │   时间段: "近7天"                                     │ │
│  │   数量: 50                                            │ │
│  │   价差阈值: 30%                                       │ │
│  │   销量增长: 20%                                       │ │
│  │   是否包含官方: True                                  │ │
│  └──────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
                         ↓ HTTP POST (发送JSON)
┌────────────────────────────────────────────────────────────┐
│  第2步：服务器接收参数                                       │
├────────────────────────────────────────────────────────────┤
│  服务器接收到的数据:                                        │
│  {                                                          │
│    "category": "女装/连衣裙",                               │
│    "timerange": "近7天",                                    │
│    "count": 50,                                             │
│    "discount_threshold": 0.30,                              │
│    "growth_threshold": 0.20,                                │
│    "allow_official": true                                   │
│  }                                                          │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第3步：服务器爬取抖音（无头浏览器）                         │
├────────────────────────────────────────────────────────────┤
│  from selenium import webdriver                             │
│                                                              │
│  options = webdriver.ChromeOptions()                        │
│  options.add_argument('--headless')  # ✅ 无头模式          │
│  options.add_argument('--no-sandbox')                       │
│  driver = webdriver.Chrome(options=options)                 │
│                                                              │
│  driver.get("https://haohuo.jinritemai.com")               │
│  # 搜索类目                                                 │
│  # 应用时间段筛选                                           │
│  # 抓取前50个商品                                           │
│                                                              │
│  服务器爬到的数据:                                          │
│  [                                                           │
│    {                                                         │
│      "title": "夏季新款连衣裙女2024流行宽松显瘦气质长裙",   │
│      "price": 128.00,                                       │
│      "url": "https://haohuo.jinritemai.com/item/123",      │
│      "sales": 5000,                                         │
│      "sales_7days_ago": 3500,  # 7天前销量                 │
│      "growth_rate": 0.43,  # (5000-3500)/3500 = 43%        │
│      "image_url": "https://xxx.com/img1.jpg",              │
│      "is_official": false                                   │
│    },                                                        │
│    ... (更多商品)                                           │
│  ]                                                           │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第4步：服务器过滤（销量增长<20%的删除）                     │
├────────────────────────────────────────────────────────────┤
│  filtered_products = [                                       │
│    p for p in products                                       │
│    if p['growth_rate'] >= 0.20  # 只保留增长≥20%的          │
│  ]                                                           │
│                                                              │
│  过滤后还剩: 28个商品                                        │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第5步：服务器逐个搜索拼多多（无头浏览器）                   │
├────────────────────────────────────────────────────────────┤
│  For 每个抖音商品:                                          │
│                                                              │
│    # 新建浏览器实例                                         │
│    driver.get("https://mobile.yangkeduo.com/search")       │
│    driver.find_element('input').send_keys(商品标题)         │
│    driver.find_element('button').click()                    │
│                                                              │
│    # 爬取搜索结果（前20个）                                 │
│    pdd_products = [                                         │
│      {                                                       │
│        "title": "连衣裙女2024新款夏季显瘦气质长裙",         │
│        "price": 59.00,                                      │
│        "url": "https://mobile.yangkeduo.com/goods/456",    │
│        "image_url": "https://xxx.com/pdd1.jpg"             │
│      },                                                      │
│      ... (更多候选)                                         │
│    ]                                                         │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第6步：服务器AI匹配（判断是否同款）                         │
├────────────────────────────────────────────────────────────┤
│  from ai_matcher import ProductMatcher                      │
│  matcher = ProductMatcher()                                 │
│                                                              │
│  # 抖音商品 vs 拼多多候选列表                               │
│  matches = matcher.match_products(                          │
│    douyin_product,                                          │
│    pdd_products                                             │
│  )                                                           │
│                                                              │
│  # 返回: [(商品, 相似度), ...]                              │
│  # 例如: [(pdd_product_1, 0.87), (pdd_product_2, 0.65), ...]│
│                                                              │
│  # 只保留相似度>0.6的                                       │
│  best_match = [m for m in matches if m[1] >= 0.6][0]       │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第7步：服务器价格对比（计算价差）                           │
├────────────────────────────────────────────────────────────┤
│  douyin_price = 128.00                                      │
│  pdd_price = 59.00                                          │
│                                                              │
│  price_diff = (128 - 59) / 128 = 0.539  # 53.9%            │
│                                                              │
│  if price_diff >= 0.30:  # 满足30%阈值                     │
│    符合条件 ✅                                              │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第8步：服务器返回结果（JSON）                               │
├────────────────────────────────────────────────────────────┤
│  HTTP Response:                                              │
│  {                                                           │
│    "success": true,                                          │
│    "total": 15,  # 找到15个符合条件的                       │
│    "data": [                                                 │
│      {                                                       │
│        "title": "夏季新款连衣裙女2024流行宽松显瘦气质长裙", │
│        "douyin_price": 128.00,                              │
│        "douyin_url": "https://haohuo.jinritemai.com/123",  │
│        "douyin_sales": 5000,                                │
│        "growth_rate": "43%",  # ✅ 服务器计算好的            │
│        "pdd_price": 59.00,                                  │
│        "pdd_urls": [                                        │
│          "https://mobile.yangkeduo.com/goods/456",         │
│          "https://mobile.yangkeduo.com/goods/789"          │
│        ],                                                    │
│        "discount_rate": "53.9%",  # ✅ 服务器计算好的        │
│        "similarity": "87%",  # ✅ 服务器计算好的             │
│        "image_url": "https://xxx.com/img1.jpg"             │
│      },                                                      │
│      ... (更多商品)                                         │
│    ]                                                         │
│  }                                                           │
└────────────────────────────────────────────────────────────┘
                         ↓ HTTP Response (接收JSON)
┌────────────────────────────────────────────────────────────┐
│  第9步：客户端展示结果                                       │
├────────────────────────────────────────────────────────────┤
│  客户端 UI 表格:                                             │
│  ┌────┬───────────┬──────┬──────┬──────┬────────┐        │
│  │序号│ 商品标题   │抖音价│拼多多│价差  │销量增长│        │
│  ├────┼───────────┼──────┼──────┼──────┼────────┤        │
│  │ 1  │连衣裙...   │ ¥128 │ ¥59  │53.9% │ 43%    │        │
│  │ 2  │短袖T恤...  │ ¥89  │ ¥35  │60.7% │ 28%    │        │
│  │... │            │      │      │      │        │        │
│  └────┴───────────┴──────┴──────┴──────┴────────┘        │
│                                                              │
│  ❌ 客户端没有任何计算逻辑，只是显示数据                     │
└────────────────────────────────────────────────────────────┘
                         ↓ 用户点击"导出Excel"
┌────────────────────────────────────────────────────────────┐
│  第10步：客户端导出Excel（本地生成）                         │
├────────────────────────────────────────────────────────────┤
│  import pandas as pd                                         │
│  import os                                                   │
│                                                              │
│  # 把服务器返回的JSON转成DataFrame                          │
│  df = pd.DataFrame(result['data'])                          │
│                                                              │
│  # 保存到客户桌面                                           │
│  desktop = os.path.join(os.path.expanduser("~"), "Desktop")│
│  excel_path = f"{desktop}/选品结果_{timestamp}.xlsx"        │
│                                                              │
│  df.to_excel(excel_path, columns=[                          │
│    'title',           # 商品标题                            │
│    'douyin_url',      # 抖音链接（铺货用）                  │
│    'douyin_price',    # 抖音价格                            │
│    'pdd_urls',        # 拼多多链接                          │
│    'pdd_price',       # 拼多多价格                          │
│    'discount_rate',   # 价差                                │
│    'growth_rate',     # 销量增长                            │
│    'similarity'       # 相似度                              │
│  ])                                                          │
│                                                              │
│  ✅ Excel文件保存在: C:\Users\客户\Desktop\选品结果.xlsx   │
└────────────────────────────────────────────────────────────┘
                         ↓ 用户点击"一键铺货"
┌────────────────────────────────────────────────────────────┐
│  第11步：客户端调用RPA（本地执行）                           │
├────────────────────────────────────────────────────────────┤
│  import subprocess                                           │
│                                                              │
│  # 客户端调用RPA脚本                                        │
│  subprocess.Popen([                                          │
│    "python",                                                 │
│    "rpa/rpa_controller.py",                                 │
│    "--excel", excel_path,                                   │
│    "--column", "douyin_url"  # 读取"抖音链接"这一列        │
│  ])                                                          │
│                                                              │
│  ❌ RPA不与服务器通信，完全本地运行                          │
└────────────────────────────────────────────────────────────┘
                         ↓ 
┌────────────────────────────────────────────────────────────┐
│  第12步：RPA读取Excel并自动操作                              │
├────────────────────────────────────────────────────────────┤
│  import pandas as pd                                         │
│  import pyautogui                                            │
│                                                              │
│  # 读取Excel                                                │
│  df = pd.read_excel(excel_path)                             │
│  links = df['douyin_url'].tolist()                          │
│                                                              │
│  # 打开铺货软件                                             │
│  os.startfile("铺货软件.exe")                               │
│  time.sleep(5)  # 等待软件启动                              │
│                                                              │
│  # 逐个输入链接                                             │
│  for link in links:                                         │
│    # 找到输入框（图像识别）                                 │
│    pos = pyautogui.locateOnScreen('templates/input_box.png')│
│    pyautogui.click(pos)                                     │
│                                                              │
│    # 粘贴链接                                               │
│    pyautogui.hotkey('ctrl', 'v')                            │
│    pyperclip.copy(link)                                     │
│    pyautogui.hotkey('ctrl', 'v')                            │
│                                                              │
│    # 点击铺货按钮                                           │
│    pyautogui.click('templates/listing_btn.png')            │
│    time.sleep(3)  # 等待铺货完成                            │
│                                                              │
│  ✅ 全部自动完成，无需人工干预                              │
└────────────────────────────────────────────────────────────┘
```

---

## 三、哪些数据是服务器中转的？（清单）

### ✅ **服务器处理的数据**

| 数据项 | 客户端发送 | 服务器处理 | 服务器返回 |
|--------|-----------|-----------|-----------|
| **类目** | ✅ "女装/连衣裙" | ✅ 用于搜索 | ❌ |
| **时间段** | ✅ "近7天" | ✅ 用于筛选 | ❌ |
| **商品标题** | ❌ | ✅ 爬虫获取 | ✅ |
| **抖音价格** | ❌ | ✅ 爬虫获取 | ✅ |
| **抖音链接** | ❌ | ✅ 爬虫获取 | ✅ |
| **抖音销量** | ❌ | ✅ 爬虫获取 | ✅ |
| **7天前销量** | ❌ | ✅ 爬虫获取 | ❌ (只返回增长率) |
| **销量增长率** | ❌ | ✅ **计算** | ✅ "43%" |
| **商品图片URL** | ❌ | ✅ 爬虫获取 | ✅ |
| **拼多多候选商品** | ❌ | ✅ 爬虫获取 | ❌ (只返回最佳匹配) |
| **拼多多价格** | ❌ | ✅ 爬虫获取 | ✅ |
| **拼多多链接** | ❌ | ✅ 爬虫获取 | ✅ (可能多个) |
| **文本相似度** | ❌ | ✅ **AI计算** | ❌ (融入综合相似度) |
| **图片相似度** | ❌ | ✅ **AI计算** | ❌ (融入综合相似度) |
| **综合相似度** | ❌ | ✅ **计算** | ✅ "87%" |
| **价格差** | ❌ | ✅ **计算** | ✅ "53.9%" |

### ❌ **客户端不处理的数据**

```python
客户端永远看不到:
❌ 爬虫逻辑
❌ Selenium代码
❌ AI匹配算法
❌ 价格计算公式
❌ 销量增长计算公式
❌ 相似度计算算法

客户端只负责:
✅ 收集参数
✅ 显示结果
✅ 导出Excel
```

---

## 四、RPA指令流（具体到每一行）

### 方案A：Excel驱动（当前方案）

```python
# 客户端生成Excel:
# C:\Users\客户\Desktop\选品结果.xlsx

# Excel内容:
# | 商品标题 | 抖音链接 | 拼多多链接 | 价差 |
# |---------|---------|----------|------|
# | 连衣裙... | https://... | https://... | 53.9% |

# RPA读取Excel:
df = pd.read_excel("选品结果.xlsx")

# 按行处理:
for index, row in df.iterrows():
    douyin_url = row['抖音链接']
    
    # 自动操作铺货软件
    paste_to_listing_software(douyin_url)
    click_listing_button()
    wait_complete()
```

### 方案B：服务器指令驱动（可选，更安全）

如果你想让RPA也受服务器控制，可以这样：

```python
# 1. 客户端不直接调用RPA，而是请求服务器
POST /api/get-rpa-commands
{
  "result_id": "abc123"  # 选品结果ID
}

# 2. 服务器返回RPA指令
{
  "commands": [
    {
      "action": "open_software",
      "params": {
        "software_path": "C:\\铺货软件\\app.exe"
      }
    },
    {
      "action": "input_link",
      "params": {
        "link": "https://haohuo.jinritemai.com/123",
        "target": "input_box"
      }
    },
    {
      "action": "click_button",
      "params": {
        "button": "listing_btn"
      }
    },
    {
      "action": "wait",
      "params": {
        "seconds": 3
      }
    }
  ]
}

# 3. 客户端RPA执行指令
for cmd in commands:
    if cmd['action'] == 'input_link':
        rpa.input_text(cmd['params']['link'])
    elif cmd['action'] == 'click_button':
        rpa.click(cmd['params']['button'])
    # ...
```

**优势**：
- ✅ RPA逻辑也在服务器
- ✅ 可以远程更新RPA流程
- ✅ 更难破解

**劣势**：
- ❌ 增加网络依赖
- ❌ RPA需要实时网络

---

## 五、无头浏览器详解

### ✅ 是的，服务器用无头浏览器

```python
# 服务器端代码（在你的Linux服务器运行）

from selenium import webdriver
from selenium.webdriver.chrome.options import Options

def scrape_douyin(category):
    # 配置无头模式
    options = Options()
    options.add_argument('--headless')  # ✅ 无头
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--disable-gpu')
    options.add_argument('user-agent=Mozilla/5.0...')
    
    # 启动浏览器（看不见窗口）
    driver = webdriver.Chrome(options=options)
    
    # 访问抖音
    driver.get("https://haohuo.jinritemai.com")
    
    # 搜索
    search_box = driver.find_element('css selector', 'input.search')
    search_box.send_keys(category)
    search_box.submit()
    
    # 等待结果加载
    time.sleep(3)
    
    # 抓取商品
    products = driver.find_elements('css selector', '.product-item')
    
    results = []
    for p in products:
        results.append({
            'title': p.find_element('.title').text,
            'price': float(p.find_element('.price').text.replace('¥', '')),
            'url': p.find_element('a').get_attribute('href'),
            'image_url': p.find_element('img').get_attribute('src')
        })
    
    driver.quit()
    return results
```

**特点**：
- ✅ 服务器后台运行（看不见浏览器）
- ✅ 不需要显示器
- ✅ 可以同时跑多个（并发）
- ✅ 资源占用少

---

## 六、Excel生成详解

```python
# ========== 客户端代码 ==========

import pandas as pd
import os
from datetime import datetime

def export_to_excel(result_data):
    """
    把服务器返回的JSON数据导出为Excel
    """
    # 服务器返回的数据格式
    # result_data = {
    #     'success': True,
    #     'data': [
    #         {
    #             'title': '...',
    #             'douyin_url': '...',
    #             'douyin_price': 128,
    #             'pdd_urls': ['...', '...'],
    #             'pdd_price': 59,
    #             'discount_rate': '53.9%',
    #             'growth_rate': '43%',
    #             'similarity': '87%'
    #         },
    #         ...
    #     ]
    # }
    
    # 转成DataFrame
    df = pd.DataFrame(result_data['data'])
    
    # 处理拼多多多链接（拼接成字符串）
    df['pdd_urls'] = df['pdd_urls'].apply(lambda x: '\n'.join(x))
    
    # 调整列顺序
    df = df[[
        'title',
        'douyin_url',
        'douyin_price',
        'douyin_sales',
        'growth_rate',
        'pdd_urls',
        'pdd_price',
        'discount_rate',
        'similarity'
    ]]
    
    # 重命名列（中文）
    df.columns = [
        '商品标题',
        '抖音链接',
        '抖音价格',
        '抖音销量',
        '销量增长',
        '拼多多链接',
        '拼多多价格',
        '价差',
        '相似度'
    ]
    
    # 保存到桌面
    desktop = os.path.join(os.path.expanduser("~"), "Desktop")
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"选品结果_{timestamp}.xlsx"
    filepath = os.path.join(desktop, filename)
    
    # 导出（带格式）
    with pd.ExcelWriter(filepath, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='选品结果')
        
        # 获取workbook和worksheet对象
        workbook = writer.book
        worksheet = writer.sheets['选品结果']
        
        # 设置列宽
        worksheet.set_column('A:A', 40)  # 商品标题
        worksheet.set_column('B:B', 60)  # 抖音链接
        worksheet.set_column('C:C', 12)  # 价格
        worksheet.set_column('D:D', 12)  # 销量
        worksheet.set_column('E:E', 12)  # 增长
        worksheet.set_column('F:F', 60)  # 拼多多链接
        worksheet.set_column('G:G', 12)  # 价格
        worksheet.set_column('H:H', 10)  # 价差
        worksheet.set_column('I:I', 10)  # 相似度
        
        # 设置格式
        header_format = workbook.add_format({
            'bold': True,
            'bg_color': '#4F81BD',
            'font_color': 'white',
            'align': 'center'
        })
        
        # 应用表头格式
        for col_num, value in enumerate(df.columns.values):
            worksheet.write(0, col_num, value, header_format)
    
    print(f"✅ Excel导出成功: {filepath}")
    return filepath
```

**流程**：
1. 服务器返回JSON数据
2. 客户端用pandas转成DataFrame
3. 格式化（调整列、设置宽度、颜色）
4. 保存到客户桌面
5. RPA读取这个Excel文件

---

## 七、总结（一句话版）

| 组件 | 干什么 | 不干什么 |
|------|-------|---------|
| **服务器** | 爬虫、AI匹配、计算、返回JSON | ❌ 不生成Excel、不控制RPA |
| **客户端** | 收集参数、显示结果、生成Excel、调用RPA | ❌ 不爬虫、不计算 |
| **RPA** | 读Excel、自动操作铺货软件 | ❌ 不联网、不与服务器通信 |

**数据流向**：
```
用户输入 → 客户端 → 服务器(爬+算) → 客户端(显示) → Excel → RPA(铺货)
```

