# 智能选品系统 - 测试文档

## 📋 概述

本项目包含三层测试体系：
1. **单元测试**：测试独立函数和工具方法
2. **集成测试**：测试GUI组件和完整工作流
3. **EXE自动化测试**：测试打包后的可执行文件

---

## 🚀 快速开始

### Windows

```batch
# 运行所有测试（单元+EXE）
run_tests.bat

# 仅运行单元测试
pytest tests/ -v
```

### Linux/Mac

```bash
# 运行单元测试
./run_tests.sh

# 或手动运行
pytest tests/ -v --cov=. --cov-report=html
```

---

## 📦 环境准备

### 1. 安装系统依赖（Linux/WSL）

**如果在Linux或WSL环境下运行测试，需要先安装tkinter：**

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y python3-tk tk-dev

# CentOS/RHEL
sudo yum install -y python3-tkinter tk-devel

# Arch Linux
sudo pacman -S tk
```

**注意**：本项目已在测试框架中内置GUI模块Mock，即使不安装tkinter也能运行单元测试。但为了更好的兼容性，建议安装。

### 2. 安装测试依赖

```bash
# 单元测试依赖
pip install -r requirements_test.txt

# 客户端运行时依赖（测试时需要）
pip install customtkinter requests pillow pandas openpyxl cryptography pyperclip

# EXE测试依赖（仅Windows）
pip install -r requirements_test_exe.txt
```

### 3. 一键安装（推荐）

**Linux/WSL：**
```bash
# 运行便捷安装脚本
./setup-test-env.sh
```

**Windows：**
```bash
# 安装所有依赖
pip install -r requirements_test.txt
pip install customtkinter requests pillow pandas openpyxl cryptography pyperclip
```

### 4. 配置测试环境

创建 `config_client.json`（可选，用于测试配置解析）：

```json
{
  "server_url": "http://127.0.0.1:5000"
}
```

---

## 🧪 运行测试

### 单元测试

```bash
# 运行所有单元测试
pytest tests/ -v

# 运行特定测试文件
pytest tests/test_config.py -v

# 运行特定测试用例
pytest tests/test_utils.py::TestHardwareID::test_hardware_id_format -v

# 生成覆盖率报告
pytest tests/ --cov=. --cov-report=html
```

### EXE自动化测试

```bash
# 前提：先构建EXE
pyinstaller modern_client_ultimate.py

# 运行EXE测试（仅Windows）
pytest tests_exe/ -v

# 运行特定EXE测试
pytest tests_exe/test_exe_startup.py -v
```

### 带标记的测试

```bash
# 仅运行单元测试
pytest -m unit

# 仅运行集成测试
pytest -m integration

# 跳过慢速测试
pytest -m "not slow"
```

---

## 📊 查看测试报告

### 覆盖率报告

运行测试后，打开 `htmlcov/index.html` 查看详细覆盖率报告。

```bash
# Windows
start htmlcov/index.html

# Linux
xdg-open htmlcov/index.html

# Mac
open htmlcov/index.html
```

### 测试失败截图

EXE测试失败时，截图自动保存在 `screenshots/` 目录。

---

## 🔧 测试配置

### pytest.ini

```ini
[pytest]
testpaths = tests
addopts = -v --strict-markers --tb=short
markers =
    unit: 单元测试
    integration: 集成测试
    slow: 慢速测试
    gui: GUI测试
```

### .coveragerc

配置代码覆盖率统计规则，排除测试文件、备份文件等。

---

## 📁 测试目录结构

```
client/
├── tests/                      # 单元/集成测试
│   ├── __init__.py
│   ├── conftest.py            # pytest配置和fixtures
│   ├── test_config.py         # 配置解析测试
│   ├── test_utils.py          # 工具函数测试
│   ├── test_api_client.py     # API调用测试（Mock）
│   ├── test_gui_components.py # GUI组件测试
│   └── test_workflows.py      # 端到端工作流测试
│
├── tests_exe/                  # EXE自动化测试
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_exe_startup.py    # EXE启动测试
│   ├── test_exe_login.py      # 登录交互测试
│   ├── test_exe_navigation.py # 页面导航测试
│   └── utils/
│       ├── gui_automation.py  # pywinauto封装
│       └── screenshot_compare.py
│
├── pytest.ini                  # pytest配置
├── .coveragerc                 # 覆盖率配置
├── requirements_test.txt       # 单元测试依赖
├── requirements_test_exe.txt   # EXE测试依赖
├── run_tests.bat              # Windows测试脚本
└── run_tests.sh               # Linux/Mac测试脚本
```

---

## 🎯 测试覆盖范围

### 单元测试 (tests/)

#### test_config.py
- ✅ 环境变量优先级测试
- ✅ config_client.json读取测试
- ✅ 默认值回落测试
- ✅ JSON解析失败容错测试
- ✅ 空值处理测试
- ✅ 配置路径生成测试

#### test_utils.py
- ✅ 硬件ID格式验证
- ✅ 硬件ID一致性测试
- ✅ 客户端ID生成测试
- ✅ 客户端ID唯一性测试
- ✅ 配置文件读写测试
- ✅ 主题颜色定义测试

#### test_api_client.py
- ✅ 注册API测试（成功/失败/超时）
- ✅ 授权验证测试（403/成功）
- ✅ 登录API测试（需要验证码/直接成功）
- ✅ 验证码提交测试
- ✅ 截图轮询测试
- ✅ 爬取API测试

#### test_gui_components.py
- ✅ 页面切换逻辑测试
- ✅ 页面切换去抖测试
- ✅ 菜单高亮更新测试
- ✅ 错误提示不跳页测试
- ✅ 登录状态管理测试
- ✅ 试用倒计时测试
- ✅ 版本号显示测试

#### test_workflows.py
- ✅ 完整用户流程测试（注册→登录→选品→导出）
- ✅ 异常场景测试（服务器不可达、授权过期、试用期结束）
- ✅ 状态持久化测试
- ✅ RPA集成测试
- ✅ 性能基准测试

### EXE自动化测试 (tests_exe/)

#### test_exe_startup.py
- ✅ EXE启动测试
- ✅ 窗口标题验证
- ✅ 左侧菜单可见性测试
- ✅ 默认页面验证
- ✅ 启动性能测试

#### test_exe_navigation.py
- ✅ 导航到各页面测试
- ✅ 返回登录页测试
- ✅ 多次页面切换测试
- ✅ 页面切换性能测试

#### test_exe_login.py
- ✅ 登录表单存在性测试
- ⏸️ 登录凭证填充测试（需Mock服务器）
- ⏸️ 登录按钮点击测试（需Mock服务器）
- ✅ 实时预览区域测试

---

## ⚙️ 高级用法

### Mock服务器

使用 `responses` 库Mock API响应：

```python
import responses

@responses.activate
def test_api_call():
    responses.add(
        responses.POST,
        'http://127.0.0.1:5000/api/register',
        json={'success': True, 'client_id': 'test'},
        status=200
    )
    
    # 测试代码...
```

### 自定义Fixtures

在 `conftest.py` 中添加：

```python
@pytest.fixture
def custom_config():
    return {'key': 'value'}

def test_something(custom_config):
    assert custom_config['key'] == 'value'
```

### 参数化测试

```python
@pytest.mark.parametrize("input,expected", [
    ("test1", "result1"),
    ("test2", "result2"),
])
def test_multiple_cases(input, expected):
    assert process(input) == expected
```

---

## 🐛 调试失败测试

### 查看详细输出

```bash
# 显示print输出
pytest -s

# 显示详细回溯
pytest --tb=long

# 在第一个失败处停止
pytest -x

# 进入调试器
pytest --pdb
```

### 查看覆盖率未达标的代码

```bash
# 生成报告后查看
pytest --cov=. --cov-report=term-missing
```

---

## 📈 覆盖率目标

- **工具函数**：≥90%
- **配置逻辑**：≥85%
- **API客户端**：≥80%
- **GUI组件**：≥60%（CustomTkinter难以完全Mock）

---

## 🔗 CI/CD集成

### GitHub Actions

测试已集成到 `.github/workflows/build-windows.yml`：

- 每次推送自动运行单元测试
- 构建EXE后运行自动化测试
- 生成覆盖率报告并上传
- 测试失败时保存截图

---

## ❓ 常见问题

### Q: 为什么EXE测试在Linux上跳过？
A: EXE测试依赖pywinauto，仅支持Windows。Linux上会自动跳过。

### Q: 如何加快测试速度？
A: 使用 `pytest -n auto` 启用并行测试（需安装pytest-xdist）。

### Q: 测试失败怎么办？
A: 查看 `htmlcov/index.html` 定位未覆盖代码，或查看 `screenshots/` 目录的失败截图。

### Q: 如何添加新测试？
A: 在 `tests/` 目录创建 `test_*.py` 文件，pytest会自动发现。

---

## 📞 支持

如有问题，请查看：
- [GitHub Issues](https://github.com/zhiqiangsun2025-droid/price-suite/issues)
- [测试覆盖率报告](htmlcov/index.html)

---

*最后更新: 2025-10-12*

