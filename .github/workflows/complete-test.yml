name: å®Œæ•´æµ‹è¯•æµç¨‹ (å•å…ƒ+é›†æˆ+E2E)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ========== Job 1: å•å…ƒæµ‹è¯• (Linuxç¯å¢ƒ) ==========
  unit-tests-linux:
    name: å•å…ƒæµ‹è¯• (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install pytest pytest-cov pytest-mock
        pip install requests pandas openpyxl cryptography
    
    - name: å•å…ƒæµ‹è¯• - å·¥å…·å‡½æ•°
      run: |
        cd client
        # æµ‹è¯•ä¸ä¾èµ–GUIçš„å‡½æ•°
        python3 -c "
import sys
sys.path.insert(0, '.')
# æµ‹è¯•ç¡¬ä»¶IDç”Ÿæˆ
from modern_client_ultimate import get_hardware_id, get_config_path, Config
hw_id = get_hardware_id()
assert len(hw_id) == 32, f'ç¡¬ä»¶IDé•¿åº¦é”™è¯¯: {len(hw_id)}'
assert hw_id != 'HARDWARE_ERROR', 'ç¡¬ä»¶IDç”Ÿæˆå¤±è´¥'
print('âœ“ ç¡¬ä»¶IDç”Ÿæˆæµ‹è¯•é€šè¿‡')

# æµ‹è¯•é…ç½®è·¯å¾„
config_path = get_config_path()
assert config_path.endswith('config.json'), f'é…ç½®è·¯å¾„é”™è¯¯: {config_path}'
print('âœ“ é…ç½®è·¯å¾„æµ‹è¯•é€šè¿‡')

# æµ‹è¯•é…ç½®ç±»
assert Config.TRIAL_DURATION == 3600, 'è¯•ç”¨æ—¶é•¿é…ç½®é”™è¯¯'
assert Config.WINDOW_WIDTH == 1400, 'çª—å£å®½åº¦é…ç½®é”™è¯¯'
print('âœ“ é…ç½®ç±»æµ‹è¯•é€šè¿‡')

print('\\nâœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡')
"
      continue-on-error: false

  # ========== Job 2: é›†æˆæµ‹è¯• (Linuxç¯å¢ƒ) ==========
  integration-tests:
    name: é›†æˆæµ‹è¯• (APIé€šä¿¡)
    runs-on: ubuntu-latest
    needs: unit-tests-linux
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install requests pytest
    
    - name: é›†æˆæµ‹è¯• - æ¨¡æ‹ŸAPIè°ƒç”¨
      run: |
        cd client
        python3 -c "
import requests
import json

# æµ‹è¯•æœåŠ¡å™¨è¿æ¥ï¼ˆä½¿ç”¨å…¬å¼€APIæµ‹è¯•ï¼‰
try:
    # è¿™é‡Œåº”è¯¥æµ‹è¯•ä½ çš„å®é™…APIï¼Œç›®å‰åªæµ‹è¯•ç½‘ç»œåŠŸèƒ½
    response = requests.get('https://api.github.com', timeout=5)
    assert response.status_code == 200, f'HTTPè¯·æ±‚å¤±è´¥: {response.status_code}'
    print('âœ“ HTTPè¯·æ±‚åŠŸèƒ½æ­£å¸¸')
    
    # æµ‹è¯•JSONå¤„ç†
    data = {'test': 'data'}
    json_str = json.dumps(data, ensure_ascii=False)
    parsed = json.loads(json_str)
    assert parsed['test'] == 'data', 'JSONå¤„ç†é”™è¯¯'
    print('âœ“ JSONå¤„ç†åŠŸèƒ½æ­£å¸¸')
    
    print('\\nâœ… é›†æˆæµ‹è¯•é€šè¿‡')
except Exception as e:
    print(f'âŒ é›†æˆæµ‹è¯•å¤±è´¥: {e}')
    exit(1)
"

  # ========== Job 3: Windows GUIæµ‹è¯• ==========
  gui-tests-windows:
    name: GUIæµ‹è¯• (Windowså®Œæ•´ç¯å¢ƒ)
    runs-on: windows-latest
    needs: unit-tests-linux
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…å®Œæ•´ä¾èµ–
      run: |
        pip install -r client/requirements_modern.txt
        pip install pytest pytest-qt pywinauto pillow
    
    - name: éªŒè¯GUIåº“å¯ç”¨
      run: |
        python -c "import customtkinter; print('âœ“ CustomTkinterå¯ç”¨')"
        python -c "import tkinter; print('âœ“ Tkinterå¯ç”¨')"
    
    - name: GUIåŸºç¡€æµ‹è¯•
      run: |
        cd client
        python -c "
import customtkinter as ctk
print('âœ“ CustomTkinterå¯¼å…¥æˆåŠŸ')

# æµ‹è¯•èƒ½å¦åˆ›å»ºçª—å£ï¼ˆä¸æ˜¾ç¤ºï¼‰
try:
    root = ctk.CTk()
    root.withdraw()  # éšè—çª—å£
    print('âœ“ å¯ä»¥åˆ›å»ºCTkçª—å£')
    root.destroy()
    print('âœ“ çª—å£é”€æ¯æ­£å¸¸')
except Exception as e:
    print(f'âŒ GUIæµ‹è¯•å¤±è´¥: {e}')
    exit(1)

print('\\nâœ… GUIåŸºç¡€æµ‹è¯•é€šè¿‡')
"
    
    - name: å¯¼å…¥ä¸»ç¨‹åºæµ‹è¯•
      run: |
        cd client
        python -c "
import sys
import os

# æµ‹è¯•èƒ½å¦å¯¼å…¥ä¸»ç¨‹åº
try:
    import modern_client_ultimate
    print(f'âœ“ ä¸»ç¨‹åºå¯¼å…¥æˆåŠŸï¼Œç‰ˆæœ¬: {modern_client_ultimate.VERSION}')
    print(f'âœ“ æœåŠ¡å™¨åœ°å€: {modern_client_ultimate.SERVER_URL}')
    print(f'âœ“ Configç±»å­˜åœ¨: {hasattr(modern_client_ultimate, \"Config\")}')
    print(f'âœ“ Themeç±»å­˜åœ¨: {hasattr(modern_client_ultimate, \"Theme\")}')
    print(f'âœ“ UltimateAppç±»å­˜åœ¨: {hasattr(modern_client_ultimate, \"UltimateApp\")}')
    
    print('\\nâœ… ä¸»ç¨‹åºç»“æ„å®Œæ•´')
except Exception as e:
    print(f'âŒ ä¸»ç¨‹åºå¯¼å…¥å¤±è´¥: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"

  # ========== Job 4: ç«¯åˆ°ç«¯æµ‹è¯• (Windows) ==========
  e2e-tests-windows:
    name: ç«¯åˆ°ç«¯æµ‹è¯• (E2E)
    runs-on: windows-latest
    needs: gui-tests-windows
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r client/requirements_modern.txt
        pip install pywinauto pytest
    
    - name: E2Eæµ‹è¯• - åº”ç”¨å¯åŠ¨
      run: |
        cd client
        python -c "
import sys
import threading
import time

# æµ‹è¯•åº”ç”¨èƒ½å¦åˆ›å»ºï¼ˆä¸é˜»å¡æµ‹è¯•ï¼‰
def test_app_creation():
    try:
        import modern_client_ultimate
        # æ³¨æ„ï¼šä¸è°ƒç”¨mainloopï¼Œåªæµ‹è¯•å®ä¾‹åŒ–
        print('âœ“ åº”ç”¨ç±»å¯ä»¥å¯¼å…¥')
        print(f'âœ“ ç‰ˆæœ¬å·: {modern_client_ultimate.VERSION}')
        print(f'âœ“ é…ç½®å®Œæ•´: Trial={modern_client_ultimate.Config.TRIAL_DURATION}s')
        return True
    except Exception as e:
        print(f'âŒ åº”ç”¨åˆ›å»ºå¤±è´¥: {e}')
        import traceback
        traceback.print_exc()
        return False

if test_app_creation():
    print('\\nâœ… E2EåŸºç¡€æµ‹è¯•é€šè¿‡')
    exit(0)
else:
    exit(1)
"
    
    - name: æˆªå›¾æµ‹è¯•ï¼ˆå¦‚æœæœ‰æ˜¾ç¤ºæœåŠ¡å™¨ï¼‰
      run: |
        echo "ğŸ“¸ æˆªå›¾æµ‹è¯•éœ€è¦è™šæ‹Ÿæ˜¾ç¤ºæœåŠ¡å™¨"
        echo "å½“å‰ç¯å¢ƒï¼š$env:OS"
      continue-on-error: true

  # ========== Job 5: æ‰“åŒ…æµ‹è¯• ==========
  build-test:
    name: æ‰“åŒ…æµ‹è¯•
    runs-on: windows-latest
    needs: [unit-tests-linux, gui-tests-windows]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r client/requirements_modern.txt
        pip install pyinstaller==6.3.0
    
    - name: æ‰“åŒ…EXE
      run: |
        cd client
        # ä¸ä½¿ç”¨iconé¿å…é”™è¯¯
        pyinstaller `
          --name="æ™ºèƒ½é€‰å“ç³»ç»Ÿ-20251021005" `
          --onefile `
          --windowed `
          --add-data="config_client.json;." `
          --hidden-import=PIL._tkinter_finder `
          --noconfirm `
          modern_client_ultimate.py
    
    - name: éªŒè¯EXEæ–‡ä»¶
      run: |
        $exePath = "client\dist\æ™ºèƒ½é€‰å“ç³»ç»Ÿ-20251021005.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ… EXEæ–‡ä»¶å­˜åœ¨"
          Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          if ($fileSize -gt 200) {
            Write-Host "âš ï¸  è­¦å‘Š: æ–‡ä»¶è¿‡å¤§ (>200MB)"
          }
          
          $hash = Get-FileHash $exePath -Algorithm SHA256
          Write-Host "ğŸ” SHA256: $($hash.Hash)"
        } else {
          Write-Host "âŒ EXEæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        }
    
    - name: ä¸Šä¼ EXE
      uses: actions/upload-artifact@v4
      with:
        name: æ™ºèƒ½é€‰å“ç³»ç»Ÿ-Windows-20251021005
        path: client/dist/*.exe
        retention-days: 30

  # ========== Job 6: æµ‹è¯•æŠ¥å‘Š ==========
  test-report:
    name: æµ‹è¯•æ€»ç»“æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [unit-tests-linux, integration-tests, gui-tests-windows, e2e-tests-windows, build-test]
    if: always()
    
    steps:
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "================================"
        echo "   æµ‹è¯•æ‰§è¡Œæ€»ç»“"
        echo "================================"
        echo ""
        echo "âœ… å•å…ƒæµ‹è¯• (Linux): ${{ needs.unit-tests-linux.result }}"
        echo "âœ… é›†æˆæµ‹è¯• (Linux): ${{ needs.integration-tests.result }}"
        echo "âœ… GUIæµ‹è¯• (Windows): ${{ needs.gui-tests-windows.result }}"
        echo "âœ… E2Eæµ‹è¯• (Windows): ${{ needs.e2e-tests-windows.result }}"
        echo "âœ… æ‰“åŒ…æµ‹è¯• (Windows): ${{ needs.build-test.result }}"
        echo ""
        echo "================================"

