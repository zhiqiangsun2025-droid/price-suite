name: è‡ªåŠ¨æ‰“åŒ…Windows EXE

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]
    paths:
      - 'client/**'
  pull_request:
    branches: [ main, master ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-windows-exe:
    name: æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r client/requirements_modern.txt
        pip install pyinstaller==6.3.0
        pip install pytest pytest-mock
    
    - name: ğŸ§ª æ‰“åŒ…å‰æµ‹è¯•
      run: |
        cd client
        python -m pytest tests/test_utils.py tests/test_config.py -v
      continue-on-error: true
    
    - name: ğŸ”¨ æ‰“åŒ…EXE
      run: |
        cd client
        pyinstaller `
          --name="æ™ºèƒ½é€‰å“ç³»ç»Ÿ-v10.10.5" `
          --onefile `
          --windowed `
          --icon=icon.ico `
          --add-data="config_client.json;." `
          --hidden-import=PIL._tkinter_finder `
          --hidden-import=babel.numbers `
          --noconfirm `
          modern_client_ultimate.py
      continue-on-error: false
    
    - name: ğŸ“‹ æŸ¥çœ‹ç”Ÿæˆæ–‡ä»¶
      run: |
        dir client\dist
        
    - name: ğŸ“Š æ£€æŸ¥æ–‡ä»¶å¤§å°
      run: |
        $fileSize = (Get-Item "client\dist\æ™ºèƒ½é€‰å“ç³»ç»Ÿ-v10.10.5.exe").Length / 1MB
        Write-Host "EXEæ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
        if ($fileSize -gt 100) {
          Write-Host "âš ï¸ è­¦å‘Š: EXEæ–‡ä»¶è¿‡å¤§ (>100MB)"
        }
    
    - name: ğŸ” éªŒè¯EXEæ–‡ä»¶
      run: |
        if (Test-Path "client\dist\æ™ºèƒ½é€‰å“ç³»ç»Ÿ-v10.10.5.exe") {
          Write-Host "âœ… EXEæ–‡ä»¶å­˜åœ¨"
          $hash = Get-FileHash "client\dist\æ™ºèƒ½é€‰å“ç³»ç»Ÿ-v10.10.5.exe" -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
        } else {
          Write-Host "âŒ EXEæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        }
    
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: æ™ºèƒ½é€‰å“ç³»ç»Ÿ-Windows-v10.10.5
        path: client/dist/*.exe
        retention-days: 30
    
    - name: âœ… æ„å»ºæˆåŠŸé€šçŸ¥
      run: |
        echo "âœ… Windows EXE æ„å»ºæˆåŠŸï¼"
        echo "ğŸ“¦ ä¸‹è½½ä½ç½®ï¼šGitHub Actions â†’ Artifacts"

  # å¯é€‰ï¼šåŒæ—¶æ„å»ºLinuxç‰ˆæœ¬
  build-linux:
    name: æ„å»ºLinuxå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r client/requirements_modern.txt
        pip install pyinstaller==6.3.0
    
    - name: ğŸ”¨ æ‰“åŒ…Linuxå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        cd client
        pyinstaller \
          --name="æ™ºèƒ½é€‰å“ç³»ç»Ÿ-v10.10.5" \
          --onefile \
          --add-data="config_client.json:." \
          --hidden-import=PIL._tkinter_finder \
          --noconfirm \
          modern_client_ultimate.py
    
    - name: â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: æ™ºèƒ½é€‰å“ç³»ç»Ÿ-Linux-v10.10.5
        path: client/dist/*
        retention-days: 30

