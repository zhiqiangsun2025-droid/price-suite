{% extends 'base.html' %}
{% block title %}å®¢æˆ·ç«¯ç®¡ç†{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="m-0">ğŸ“± å®¢æˆ·ç«¯ç®¡ç†</h5>
  <div class="alert alert-info mb-0 py-2 px-3" style="font-size: 13px;">
    ğŸ’¡ å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨æ³¨å†Œï¼Œæ‚¨åªéœ€æ‰¹å‡†æˆ–æ‹’ç»å³å¯
  </div>
</div>
<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <input class="form-control" name="q" value="{{ q }}" placeholder="æœç´¢ å®¢æˆ·å/ClientID/IP">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary">æœç´¢</button>
  </div>
</form>
<div class="table-responsive">
  <table class="table table-hover align-middle" style="min-width: 1400px;">
    <thead class="table-light">
      <tr>
        <th style="width: 40px;">ID</th>
        <th style="width: 280px;">å®¢æˆ·ç«¯ID</th>
        <th style="width: 120px;">å®¢æˆ·åç§°</th>
        <th style="width: 140px;">IPåœ°å€</th>
        <th style="width: 120px;">ç¡¬ä»¶ID</th>
        <th style="width: 100px;">çŠ¶æ€</th>
        <th style="width: 160px;">åˆ°æœŸæ—¶é—´</th>
        <th style="width: 70px;">è¯·æ±‚æ•°</th>
        <th style="width: 180px;">æœ€åè®¿é—®</th>
        <th style="min-width: 340px;">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
    {% for c in clients %}
      <tr>
        <td>{{ c[0] }}</td>
        <td>
          <div class="d-flex align-items-center">
            <code style="font-size: 10px; word-break: break-all; flex: 1; max-width: 220px;">{{ c[1] }}</code>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyText('{{ c[1] }}'); return false;" title="å¤åˆ¶å®¢æˆ·ç«¯ID">
              ğŸ“‹
            </button>
          </div>
        </td>
        <td>{{ c[2] or '-' }}</td>
        <td><small>{{ c[3] or 'ä»»æ„IP' }}</small></td>
        <td>
          <small><code style="font-size: 9px;">{{ c[4][:10] if c[4] else '-' }}...</code></small>
        </td>
        <td>
          {% if c[5] == 0 %}
            <span class="badge bg-warning text-dark">å¾…å®¡æ ¸</span>
          {% elif c[5] == 1 %}
            <span class="badge bg-success">å·²æ‰¹å‡†</span>
          {% elif c[5] == -1 %}
            <span class="badge bg-danger">å·²æ‹’ç»</span>
          {% else %}
            <span class="badge bg-secondary">æœªçŸ¥</span>
          {% endif %}
        </td>
        <td><small>{{ c[7] if c[7] else 'æ°¸ä¹…' }}</small></td>
        <td><span class="badge bg-info">{{ c[8] }}</span></td>
        <td><small>{{ c[10] if c[10] else '-' }}</small></td>
        <td>
          <!-- å¾…å®¡æ ¸ï¼šæ˜¾ç¤ºæ‰¹å‡†/æ‹’ç» -->
          {% if c[5] == 0 %}
            <a class="btn btn-sm btn-success me-1" href="{{ url_for('admin_client_approve', cid=c[0]) }}" onclick="return confirm('ç¡®è®¤æ‰¹å‡†è¯¥å®¢æˆ·ç«¯ï¼Ÿ')">
              âœ“ æ‰¹å‡†
            </a>
            <a class="btn btn-sm btn-danger me-1" href="{{ url_for('admin_client_reject', cid=c[0]) }}" onclick="return confirm('ç¡®è®¤æ‹’ç»è¯¥å®¢æˆ·ç«¯ï¼Ÿ')">
              âœ— æ‹’ç»
            </a>
          {% endif %}
          
          <!-- å·²æ‰¹å‡†ï¼šæ˜¾ç¤ºæ”¹ä¸ºå¾…å®¡æ ¸/æ‹’ç» -->
          {% if c[5] == 1 %}
            <a class="btn btn-sm btn-warning me-1" href="{{ url_for('admin_client_set_status', cid=c[0], status=0) }}" onclick="return confirm('æ”¹ä¸ºå¾…å®¡æ ¸ï¼Ÿ')">
              å¾…å®¡æ ¸
            </a>
            <a class="btn btn-sm btn-danger me-1" href="{{ url_for('admin_client_reject', cid=c[0]) }}" onclick="return confirm('ç¡®è®¤æ‹’ç»ï¼Ÿ')">
              æ‹’ç»
            </a>
          {% endif %}
          
          <!-- å·²æ‹’ç»ï¼šæ˜¾ç¤ºæ”¹ä¸ºå¾…å®¡æ ¸/æ‰¹å‡† -->
          {% if c[5] == -1 %}
            <a class="btn btn-sm btn-warning me-1" href="{{ url_for('admin_client_set_status', cid=c[0], status=0) }}" onclick="return confirm('æ”¹ä¸ºå¾…å®¡æ ¸ï¼Ÿ')">
              å¾…å®¡æ ¸
            </a>
            <a class="btn btn-sm btn-success me-1" href="{{ url_for('admin_client_approve', cid=c[0]) }}" onclick="return confirm('ç¡®è®¤æ‰¹å‡†ï¼Ÿ')">
              âœ“ æ‰¹å‡†
            </a>
          {% endif %}
          
          <a class="btn btn-sm btn-outline-secondary me-1" href="{{ url_for('admin_client_edit', cid=c[0]) }}">ç¼–è¾‘</a>
          <a class="btn btn-sm btn-outline-info" href="{{ url_for('admin_logs', client_id=c[1]) }}">æ—¥å¿—</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
function copyText(text) {
  // æ–¹æ¡ˆ1ï¼šä½¿ç”¨Clipboard APIï¼ˆéœ€è¦HTTPSï¼‰
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('âœ“ å·²å¤åˆ¶å®¢æˆ·ç«¯ID');
    }).catch(err => {
      // å¤±è´¥ï¼Œä½¿ç”¨æ–¹æ¡ˆ2
      fallbackCopy(text);
    });
  } else {
    // æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•ï¼ˆå…¼å®¹HTTPï¼‰
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  // åˆ›å»ºä¸´æ—¶textarea
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  
  // é€‰æ‹©å¹¶å¤åˆ¶
  textarea.select();
  textarea.setSelectionRange(0, 99999); // å…¼å®¹ç§»åŠ¨è®¾å¤‡
  
  let success = false;
  try {
    success = document.execCommand('copy');
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥:', err);
  }
  
  document.body.removeChild(textarea);
  
  if (success) {
    showToast('âœ“ å·²å¤åˆ¶å®¢æˆ·ç«¯ID');
  } else {
    // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤ºé€‰æ‹©æ¡†è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
    prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼ˆCtrl+Cï¼‰:', text);
  }
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
  toast.style.zIndex = '9999';
  toast.innerHTML = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}
</script>

<!-- é”™è¯¯ç è¯´æ˜ -->
<div class="alert alert-info mt-4">
  <strong>ğŸ“‹ é”™è¯¯ç è¯´æ˜ï¼š</strong>
  <ul class="mb-0 mt-2">
    <li><code>101</code>: ç¼ºå°‘æˆæƒä¿¡æ¯</li>
    <li><code>102</code>: å®¢æˆ·ç«¯ä¸å­˜åœ¨</li>
    <li><code>103</code>: å®¢æˆ·ç«¯å·²è¢«æ‹’ç»</li>
    <li><code>104</code>: IPåœ°å€æœªæˆæƒ</li>
    <li><code>105</code>: æˆæƒå·²è¿‡æœŸ</li>
  </ul>
</div>
{% endblock %}