# 🏗️ 智能选品铺货系统 - 完整架构

## 一、系统概览

### 📋 核心功能流程

```
┌─────────────────────────────────────────────────────────────┐
│  客户端 (现代化UI - CustomTkinter)                           │
│  ┌────────────────────────────────────────────────────────┐│
│  │ 1. 输入选品条件                                         ││
│  │    - 类目: 女装/连衣裙                                  ││
│  │    - 时间段: 近7天                                      ││
│  │    - 筛选数量: 50                                       ││
│  │    - 价差阈值: 30%                                      ││
│  │    - 销量增长: 20%                                      ││
│  │    - 是否包含官方店                                     ││
│  └────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                            ↓ 发送参数（加密）
┌─────────────────────────────────────────────────────────────┐
│  服务器 (Flask + SQLite + AI)                                │
│  ┌────────────────────────────────────────────────────────┐│
│  │ 2. 三重验证                                            ││
│  │    ✓ Client ID验证                                     ││
│  │    ✓ Hardware ID验证                                   ││
│  │    ✓ IP白名单验证                                      ││
│  ├────────────────────────────────────────────────────────┤│
│  │ 3. 抖音爬虫 (Selenium)                                 ││
│  │    - 搜索类目                                          ││
│  │    - 应用时间段筛选                                    ││
│  │    - 抓取商品列表（标题/价格/销量/图片/链接）         ││
│  │    - 计算销量增长率                                    ││
│  │    - 过滤官方/自营（如果需要）                         ││
│  ├────────────────────────────────────────────────────────┤│
│  │ 4. 逐个商品匹配拼多多                                   ││
│  │    For 每个抖音商品:                                    ││
│  │      ├─> 拼多多搜索 (Selenium)                         ││
│  │      ├─> AI智能匹配 (标题+图片相似度)                  ││
│  │      ├─> 价格对比 (是否满足30%差价)                    ││
│  │      └─> 符合条件 → 加入结果列表                       ││
│  ├────────────────────────────────────────────────────────┤│
│  │ 5. 返回结果                                            ││
│  │    [{                                                  ││
│  │      title: "商品标题",                                ││
│  │      douyin_url: "抖音链接",                           ││
│  │      douyin_price: 128,                                ││
│  │      pdd_urls: ["拼多多链接1", "拼多多链接2"],         ││
│  │      pdd_price: 59,                                    ││
│  │      discount_rate: "53.9%",                           ││
│  │      growth_rate: "35%",                               ││
│  │      similarity: "87%"                                 ││
│  │    }, ...]                                             ││
│  └────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                            ↓ 返回结果（加密）
┌─────────────────────────────────────────────────────────────┐
│  客户端                                                       │
│  ┌────────────────────────────────────────────────────────┐│
│  │ 6. 展示结果                                            ││
│  │    - 表格显示所有符合条件的商品                        ││
│  │    - 可一键导出CSV到桌面                               ││
│  └────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────┐│
│  │ 7. 一键铺货                                            ││
│  │    - 点击"一键铺货"按钮                                ││
│  │    - 导出 pdd_links.csv 到桌面                         ││
│  │    - 自动调用 RPA 脚本                                 ││
│  └────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                            ↓ 调用RPA
┌─────────────────────────────────────────────────────────────┐
│  RPA 自动化 (PyAutoGUI + pywinauto + OpenCV)                │
│  ┌────────────────────────────────────────────────────────┐│
│  │ 8. 桌面自动化                                          ││
│  │    1) 启动铺货软件                                     ││
│  │    2) 等待软件窗口出现                                 ││
│  │    3) 找到输入框（图像识别/UIA）                       ││
│  │    4) 逐个输入抖音链接                                 ││
│  │    5) 点击"铺货"按钮                                   ││
│  │    6) 等待铺货完成                                     ││
│  │    7) 导出铺货结果                                     ││
│  │    8) 截图记录日志                                     ││
│  └────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

---

## 二、技术栈详解

### 🖥️ **后端服务器**

| 技术 | 用途 | 为什么选它 |
|------|------|-----------|
| **Python 3.8+** | 编程语言 | 全栈统一，生态丰富 |
| **Flask** | Web框架 | 轻量级，适合API服务 |
| **SQLite** | 数据库 | 无需安装，自包含，够用 |
| **Selenium** | 浏览器自动化 | 爬取动态网页（抖音/拼多多） |
| **jieba** | 中文分词 | 计算标题相似度 |
| **scikit-learn** | 机器学习 | TF-IDF文本相似度 |
| **OpenCV** | 图像处理 | 图片相似度对比 |
| **imagehash** | 感知哈希 | 快速图片匹配 |
| **Jinja2** | 模板引擎 | 管理后台页面渲染 |
| **Bootstrap** | CSS框架 | 管理后台UI |

**部署位置**: 你的Linux服务器（VPS/云主机）

---

### 💻 **客户端**

| 技术 | 用途 | 为什么选它 |
|------|------|-----------|
| **Python 3.8+** | 编程语言 | 与服务器统一 |
| **CustomTkinter** | GUI框架 | 现代化UI，比原生Tkinter美观 |
| **PyInstaller** | 打包工具 | 打包成exe，客户无需Python环境 |
| **requests** | HTTP客户端 | 与服务器通信 |
| **cryptography** | 加密库 | 通信加密，防破解 |

**部署位置**: 客户的Windows电脑

---

### 🤖 **RPA自动化**

| 技术 | 用途 | 为什么选它 |
|------|------|-----------|
| **PyAutoGUI** | 鼠标键盘控制 | 模拟人工操作 |
| **pywinauto** | Windows UI自动化 | 更精准的窗口控制 |
| **OpenCV** | 图像识别 | 找到按钮位置 |
| **Pillow** | 截图 | 记录操作日志 |

**部署位置**: 客户的Windows电脑（与客户端一起）

---

## 三、关键问题解答

### ❓ **1. 客户使用时需要最大化窗口吗？影响其他工作吗？**

**分场景回答**:

#### 场景1：纯爬虫+对比（不需要铺货软件）
- ✅ **不需要任何窗口**
- ✅ **完全不影响工作**
- 原理：Selenium可以无头模式运行，在后台爬取

```python
from selenium import webdriver
options = webdriver.ChromeOptions()
options.add_argument('--headless')  # 无头模式
driver = webdriver.Chrome(options=options)
```

#### 场景2：需要自动操作铺货软件（RPA）
- ⚠️ **需要窗口可见**
- ⚠️ **会占用鼠标键盘**（无法同时做其他工作）
- 原理：RPA需要"看到"界面才能点击

**推荐方案**: 

**🥇 方案A：专用虚拟机（强烈推荐）**
```
优点：
✅ 完全隔离，不影响主机
✅ 可以24小时运行
✅ 一台物理机可以跑多个虚拟机
✅ 成本低（VMware/VirtualBox免费）

配置要求：
- 2核CPU
- 4GB内存
- 40GB硬盘
- Windows 10/11

操作方式：
1. 主机正常工作
2. 虚拟机在后台运行RPA
3. 通过远程桌面查看进度（可选）
```

**🥈 方案B：云桌面**
```
优点：
✅ 不占用本地资源
✅ 按需付费

缺点：
❌ 成本较高（阿里云GPU实例 ~5元/小时）
```

**🥉 方案C：双显示器 + 工作时段**
```
- 主显示器：正常工作
- 副显示器：RPA运行（勿动鼠标）
- 或者利用非工作时段（下班后/夜间）
```

---

### ❓ **2. 如何判断拼多多商品是否是"同一种"？**

**🧠 AI智能匹配方案**:

#### 方法1：文本相似度（基础）
```python
# 使用TF-IDF + 余弦相似度
from sklearn.feature_extraction.text import TfidfVectorizer

抖音标题: "夏季新款连衣裙女2024流行宽松显瘦气质长裙"
拼多多标题: "连衣裙女2024新款夏季显瘦气质长裙"

相似度: 0.85 (85%)  ✅ 很可能是同款
```

#### 方法2：图片相似度（精准）
```python
# 使用感知哈希 + OpenCV特征匹配
import imagehash
from PIL import Image

hash1 = imagehash.phash(抖音商品图)
hash2 = imagehash.phash(拼多多商品图)

距离 = hash1 - hash2
# 距离 < 10 → 极相似（可能是同款）
```

#### 方法3：综合评分（推荐）
```python
综合得分 = 文本相似度 × 70% + 图片相似度 × 30%

# 阈值
if 综合得分 >= 0.6:
    判定为同款或相似商品
```

#### 方法4：调用百度AI（最准确，但要钱）
```python
from baidu_aip import AipImageClassify

result = client.similar_search(抖音图, 拼多多图)
# 返回: 相似度 0-100
```

**成本对比**:
- 方法1-3: 免费
- 方法4: ¥0.002/次（1万次 = 20元）

**推荐**: 先用方法3免费方案，如果准确率不够再考虑百度AI

---

### ❓ **3. 如何防止客户端软件被破解？**

**🔐 多重防护策略**（详见 `SECURITY_GUIDE.md`）:

| 防护层 | 实现方式 | 破解难度 |
|--------|---------|---------|
| **1. 架构隔离** | 核心逻辑100%在服务器 | ⭐⭐⭐⭐⭐ |
| **2. 硬件绑定** | MAC+硬盘序列号+CPU ID | ⭐⭐⭐⭐ |
| **3. IP白名单** | 只允许授权IP访问 | ⭐⭐⭐ |
| **4. 通信加密** | AES-256 + HMAC签名 | ⭐⭐⭐⭐ |
| **5. 代码混淆** | PyArmor商业级混淆 | ⭐⭐⭐⭐⭐ |
| **6. 反调试** | 检测调试器/虚拟机 | ⭐⭐⭐ |

**核心思想**:
> 客户端是"无用的壳"，即使被破解也无法独立使用

**举例**:
```python
# 客户端代码（即使被破解也没用）
def start_selection():
    params = get_user_input()  # 获取用户输入
    result = server.intelligent_selection(params)  # 调用服务器
    display_result(result)  # 显示结果
    
# 破解者拿到代码后：
# ❌ 无法独立运行（没有服务器的爬虫+匹配逻辑）
# ❌ 调用服务器会被拒绝（硬件ID+IP验证失败）
```

---

### ❓ **4. 客户端还有什么加密手段？**

**额外防护手段**:

#### 🔒 **1. PyArmor（强烈推荐）**
```bash
pip install pyarmor

# 混淆代码
pyarmor obfuscate client_app.py

# 原代码:
def login(username, password):
    if username == "admin" and password == "123":
        return True

# 混淆后:
def __pyarmor__(__0x7f3a1b, __0x9e2c4d):
    __0x1a2b3c = __0x7f3a1b ^ __0x9e2c4d
    if __0x1a2b3c == 0xdeadbeef:
        return __0x5f6e7d
```
**特点**: 商业级保护，几乎不可逆

**成本**: ¥200/年

---

#### 🗜️ **2. UPX压缩**
```bash
# 进一步混淆exe
upx --best --ultra-brute app.exe

# 效果:
# - 文件大小缩小60%+
# - 增加逆向难度
# - 运行速度不变
```

---

#### 🔐 **3. 离线许可证**
```python
# 生成7天有效的离线激活码
license = encrypt({
    'client_id': 'xxx',
    'hardware_id': 'yyy',
    'expires_at': now() + 7天
}, 服务器私钥)

# 客户端验证
if decrypt(license, 服务器公钥) is valid:
    运行程序
```

---

#### 🛡️ **4. 完整性校验**
```python
# 启动时验证exe是否被篡改
def check_integrity():
    current_hash = sha256(exe文件)
    server_hash = 从服务器获取()
    
    if current_hash != server_hash:
        print("程序已被篡改！")
        exit(1)
```

---

## 四、部署清单

### 📦 **服务器端文件**（你的服务器）

```
server/
├── app.py              # Flask主程序
├── ai_matcher.py       # AI匹配引擎
├── requirements.txt    # Python依赖
├── authorization.db    # SQLite数据库（自动生成）
├── templates/          # 管理后台HTML
│   ├── base.html
│   ├── clients.html
│   ├── rules.html
│   └── ...
└── static/
    └── css/
        └── app.css
```

**安装步骤**:
```bash
# 1. 安装Python环境
apt-get install python3 python3-pip

# 2. 安装依赖
cd server/
pip3 install -r requirements.txt

# 3. 启动服务
python3 app.py

# 4. 访问管理后台
http://你的服务器IP:5000/admin/login
```

---

### 💻 **客户端文件**（给客户）

```
智能选品系统.exe     # 打包好的程序（单文件）
使用说明.pdf         # 操作手册
```

**客户操作**:
1. 双击运行 `智能选品系统.exe`
2. 首次运行输入：
   - 服务器地址: `http://你的服务器IP:5000`
   - 客户端ID: （管理员提供）
3. 激活成功后即可使用

---

### 🤖 **RPA文件**（与客户端一起）

```
rpa/
├── rpa_controller.py   # RPA脚本
├── templates/          # 按钮图片模板
│   ├── input_box.png
│   ├── listing_btn.png
│   └── export_btn.png
└── requirements.txt    # RPA依赖
```

**安装（客户端电脑）**:
```bash
pip install pyautogui pywinauto opencv-python pillow
```

---

## 五、使用流程（客户视角）

### 📱 **完整操作流程**

```
Step 1: 打开软件
├─> 输入类目: 女装/连衣裙
├─> 选择时间: 近7天
├─> 筛选数量: 50
├─> 价差阈值: 30%
└─> 点击"开始智能选品"

↓ (服务器自动工作5-10分钟)

Step 2: 查看结果
├─> 显示符合条件的商品列表
├─> 抖音价格 vs 拼多多价格
├─> 销量增长率
└─> 相似度评分

Step 3: 导出/铺货
├─> 点击"导出CSV" → 保存到桌面
或
└─> 点击"一键铺货"
    ├─> 自动打开铺货软件
    ├─> 自动输入抖音链接
    ├─> 自动点击铺货
    └─> 完成后导出结果
```

**时间估算**:
- 服务器爬取+匹配: 5-10分钟（50个商品）
- RPA铺货: 2-3分钟/个商品

---

## 六、Q&A

**Q: 是否需要Google Chrome MCP？**
A: **不需要**。MCP适合AI自主决策的场景，我们的流程是确定性的（爬取→匹配→铺货），用Selenium足够。

**Q: 虚拟机会影响RPA速度吗？**
A: 不会。虚拟机性能损耗<10%，RPA主要受网络速度影响。

**Q: 能同时运行多个选品任务吗？**
A: 可以。服务器支持并发，多个客户端可同时使用。

**Q: 数据安全吗？**
A: 是的。所有数据在你的服务器，不经过第三方。

**Q: 服务器配置要求？**
A: 2核4G足够（支持10个并发客户端）

---

## 七、项目文件总览

```
apps/price-suite/
├── server/                         # 服务器端
│   ├── app.py                      # ✅ Flask主程序
│   ├── ai_matcher.py               # ✅ AI匹配引擎
│   ├── requirements.txt            # ✅ 依赖列表
│   ├── templates/                  # ✅ 管理后台模板
│   └── static/css/app.css          # ✅ 后台样式
│
├── client/                         # 客户端
│   ├── modern_client.py            # ✅ 现代化客户端（CustomTkinter）
│   ├── encryption.py               # ✅ 加密模块
│   ├── requirements_modern.txt     # ✅ 客户端依赖
│   ├── build_secure.bat            # ✅ 安全打包脚本
│   └── client_app.py               # ⚠️  旧版（Tkinter）
│
├── rpa/                            # RPA自动化
│   ├── rpa_controller.py           # ✅ RPA控制器
│   ├── templates/                  # 🖼️  按钮图片模板
│   └── requirements.txt            # ✅ RPA依赖
│
├── DEPLOY.md                       # 📖 部署文档
├── SECURITY_GUIDE.md               # 🔒 安全指南
└── FINAL_ARCHITECTURE.md           # 🏗️ 本文档
```

---

## 八、下一步

1. **测试服务器AI匹配**: 先用少量商品测试准确率
2. **配置RPA模板**: 截图铺货软件的按钮，保存为模板
3. **客户端美化**: 根据需求调整CustomTkinter界面
4. **部署上线**: 服务器配置HTTPS，客户端打包发布

有任何问题随时问我！🚀

