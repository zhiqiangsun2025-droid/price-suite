# 🎯 宝塔面板部署指南（推荐方案）

## 一、为什么推荐用宝塔？

✅ **简单** - 点点鼠标就搞定，不需要命令行  
✅ **管理方便** - 一键启动/停止/重启  
✅ **日志查看** - 可视化界面看日志  
✅ **SSL证书** - 一键申请HTTPS  
✅ **进程守护** - 自动重启，永不宕机  

---

## 二、宝塔部署步骤（10分钟搞定）

### 步骤1：安装Python管理器

1. 登录宝塔面板
2. 点击左侧 **软件商店**
3. 搜索 **Python项目管理器**
4. 点击 **安装**

![宝塔Python管理器](https://pic.imgdb.cn/item/python-manager.png)

---

### 步骤2：上传项目文件

#### 方法A：直接上传（推荐）

1. 在宝塔 **文件** 菜单，创建目录:
   ```
   /www/wwwroot/price-suite/
   ```

2. 上传以下文件到该目录:
   ```
   /www/wwwroot/price-suite/
   ├── server/
   │   ├── app.py
   │   ├── ai_matcher.py
   │   ├── requirements.txt
   │   ├── templates/
   │   └── static/
   └── authorization.db (启动后自动生成)
   ```

3. 或者用宝塔的 **远程下载**:
   ```bash
   # 如果你的代码在Git仓库
   cd /www/wwwroot/
   git clone https://你的仓库地址 price-suite
   ```

#### 方法B：宝塔终端（适合熟悉命令行的）

```bash
cd /www/wwwroot/
mkdir price-suite
cd price-suite

# 上传你的server文件夹
```

---

### 步骤3：创建Python项目

1. 点击左侧 **Python项目管理器**
2. 点击 **添加项目**
3. 填写信息:

| 字段 | 值 |
|------|-----|
| **项目名称** | `智能选品系统` |
| **项目路径** | `/www/wwwroot/price-suite/server` |
| **启动文件** | `app.py` |
| **端口** | `5000` |
| **Python版本** | `3.8` 或更高 |
| **启动方式** | `gunicorn` (推荐) 或 `python` |
| **进程数** | `4` |
| **是否开机自启** | ✅ 勾选 |

4. 点击 **安装模块**，输入:
   ```
   Flask
   Flask-Cors
   requests
   selenium
   jieba
   scikit-learn
   opencv-python
   imagehash
   Pillow
   ```

   或者直接安装requirements.txt:
   ```bash
   # 在项目设置里点击"终端"
   pip install -r requirements.txt
   ```

5. 点击 **启动**

---

### 步骤4：配置反向代理（可选，推荐）

**为什么要反向代理？**
- ✅ 使用域名访问（`https://api.yourdomain.com`）
- ✅ 自动申请SSL证书（HTTPS）
- ✅ 隐藏真实端口

#### 配置步骤:

1. 点击 **网站** → **添加站点**

| 字段 | 值 |
|------|-----|
| **域名** | `api.yourdomain.com` |
| **根目录** | 随便选一个 |
| **PHP版本** | 纯静态 |

2. 点击刚创建的网站 → **反向代理**

3. 添加反向代理:

| 字段 | 值 |
|------|-----|
| **代理名称** | `price-suite-api` |
| **目标URL** | `http://127.0.0.1:5000` |
| **发送域名** | `$host` |

4. 点击 **SSL** → **Let's Encrypt**，申请免费证书

5. 完成！现在可以通过 `https://api.yourdomain.com` 访问了

---

### 步骤5：测试

1. 浏览器访问:
   ```
   https://api.yourdomain.com/api/health
   ```

   应该返回:
   ```json
   {"status": "ok"}
   ```

2. 访问管理后台:
   ```
   https://api.yourdomain.com/admin/login
   ```

---

## 三、宝塔 vs 手动部署对比

| 功能 | 宝塔部署 | 手动部署 |
|------|---------|---------|
| **安装Python** | ✅ 一键安装 | ❌ 需要命令行 |
| **安装依赖** | ✅ 可视化界面 | ❌ pip命令 |
| **启动服务** | ✅ 点击启动 | ❌ nohup/systemd |
| **进程守护** | ✅ 自动重启 | ❌ 需要配置supervisor |
| **日志查看** | ✅ 网页查看 | ❌ tail -f |
| **SSL证书** | ✅ 一键申请 | ❌ 手动配置nginx |
| **重启** | ✅ 点击重启 | ❌ kill + 重新启动 |

**推荐**: 用宝塔！省时省力！

---

## 四、常见问题

### Q1: 宝塔上能跑Selenium吗？

✅ **可以！** 但需要安装Chrome/Firefox:

```bash
# 宝塔终端执行
apt-get update
apt-get install -y chromium-browser chromium-chromedriver

# 或者
yum install -y chromium chromium-headless
```

然后在代码中指定chromedriver路径:
```python
from selenium import webdriver

options = webdriver.ChromeOptions()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.binary_location = '/usr/bin/chromium-browser'

driver = webdriver.Chrome(
    executable_path='/usr/bin/chromedriver',
    options=options
)
```

### Q2: 如何查看日志？

1. 点击 **Python项目管理器**
2. 找到你的项目
3. 点击 **日志**
4. 实时查看错误信息

### Q3: 如何更新代码？

**方法1**: 宝塔文件管理器直接编辑

**方法2**: Git拉取
```bash
cd /www/wwwroot/price-suite
git pull
# 然后在宝塔界面点击"重启"
```

### Q4: 数据库在哪？

SQLite数据库文件在:
```
/www/wwwroot/price-suite/server/authorization.db
```

可以用宝塔的 **数据库** → **SQLite管理** 查看

### Q5: 性能不够怎么办？

1. 增加进程数（项目设置 → 进程数改为8）
2. 使用Redis缓存（宝塔一键安装Redis）
3. 升级服务器配置

---

## 五、生产环境配置（重要！）

### 1. 修改配置

编辑 `app.py`:

```python
# 生产环境配置
if __name__ == '__main__':
    app.run(
        host='127.0.0.1',  # 只监听本地（由nginx转发）
        port=5000,
        debug=False,  # ⚠️ 生产环境必须False
        threaded=True
    )
```

### 2. 设置环境变量

在宝塔项目设置 → **环境变量**:

| 变量名 | 值 |
|--------|-----|
| `ADMIN_PASSWORD` | `你的强密码` |
| `SECRET_KEY` | `随机32位字符串` |
| `FLASK_ENV` | `production` |

### 3. 防火墙设置

1. 宝塔 **安全** → 放行端口 `5000`（如果直接访问）
2. 或者只开放 `80` 和 `443`（如果用反向代理）

### 4. 定时备份

1. 宝塔 **计划任务**
2. 添加任务:
   - **任务类型**: Shell脚本
   - **执行周期**: 每天凌晨3点
   - **脚本内容**:
     ```bash
     cp /www/wwwroot/price-suite/server/authorization.db \
        /www/backup/authorization_$(date +%Y%m%d).db
     ```

---

## 六、完整部署流程（复制粘贴版）

### 1. 宝塔终端执行:

```bash
# 创建目录
mkdir -p /www/wwwroot/price-suite
cd /www/wwwroot/price-suite

# 上传你的server文件夹到这里
# 或者用git clone

# 安装依赖
cd server
pip3 install -r requirements.txt

# 测试运行
python3 app.py
# 按Ctrl+C停止
```

### 2. 宝塔界面操作:

1. **Python项目管理器** → **添加项目**
2. 填写信息（见上文步骤3）
3. **启动**
4. **网站** → 添加反向代理（可选）
5. **SSL** → 申请证书（可选）

### 3. 客户端配置:

```python
# 客户端中设置服务器地址
SERVER_URL = "https://api.yourdomain.com"  # 如果用了反向代理
# 或者
SERVER_URL = "http://你的服务器IP:5000"  # 直接访问
```

---

## 七、监控和维护

### 宝塔自带监控

1. **系统监控** → 查看CPU/内存/磁盘
2. **日志** → 查看访问日志/错误日志
3. **进程管理** → 查看Python进程状态

### 推荐插件

- **PM2管理器** - 更强大的进程管理
- **Nginx防火墙** - 防CC攻击
- **网站监控报警** - 自动检测宕机

---

## 八、总结

✅ **推荐用宝塔!** 原因:
1. 可视化操作，小白友好
2. 自动进程守护，永不宕机
3. 一键SSL证书，安全访问
4. 日志查看方便，调试简单
5. 定时任务、备份一应俱全

🚀 **5分钟部署完成，专注业务逻辑！**

